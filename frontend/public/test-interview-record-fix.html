<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 面试记录显示修复验证</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e3f2fd;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 15px;
        }
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .result-area {
            background: #f1f8e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            background: #ffebee;
            border-color: #ffcdd2;
            color: #c62828;
        }
        .success {
            background: #e8f5e8;
            border-color: #c8e6c9;
            color: #2e7d32;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-mock { background-color: #4caf50; }
        .status-formal { background-color: #2196f3; }
        .status-abandoned { background-color: #ff9800; }
        .status-completed { background-color: #9c27b0; }
        .status-in-progress { background-color: #f44336; }
        
        .record-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .record-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }
        .record-title {
            font-weight: bold;
            color: #333;
        }
        .record-meta {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 面试记录显示修复验证</h1>
            <p>测试会话 ac5545af-1d34-41e5-b1da-e5fffa0bcacd 的显示修复效果</p>
        </div>

        <div class="test-section">
            <div class="test-title">📝 1. 登录并获取Token</div>
            <button class="test-button" onclick="testLogin()">登录测试</button>
            <div id="loginResult" class="result-area" style="display:none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">📋 2. 获取面试记录原始数据</div>
            <button class="test-button" onclick="getRawInterviewData()">获取原始API数据</button>
            <div id="rawDataResult" class="result-area" style="display:none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">🔄 3. 测试类型转换逻辑</div>
            <button class="test-button" onclick="testTypeConversion()">测试转换逻辑</button>
            <div id="conversionResult" class="result-area" style="display:none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">📊 4. 显示格式化后的记录</div>
            <button class="test-button" onclick="getFormattedRecords()">获取格式化记录</button>
            <div id="formattedResult" class="result-area" style="display:none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">🎯 5. 验证目标会话</div>
            <button class="test-button" onclick="verifyTargetSession()">验证目标会话</button>
            <div id="targetResult" class="result-area" style="display:none;"></div>
        </div>
    </div>

    <script>
        let authToken = '';
        
        // 登录测试
        async function testLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '🔄 正在登录...';
            
            try {
                const response = await fetch('http://localhost:5001/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: '3938930977@qq.com',
                        password: '12345678'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    authToken = data.data.access_token;
                    resultDiv.className = 'result-area success';
                    resultDiv.textContent = `✅ 登录成功！\nToken: ${authToken.substring(0, 50)}...`;
                } else {
                    resultDiv.className = 'result-area error';
                    resultDiv.textContent = `❌ 登录失败: ${data.message || '未知错误'}`;
                }
            } catch (error) {
                resultDiv.className = 'result-area error';
                resultDiv.textContent = `❌ 登录异常: ${error.message}`;
            }
        }
        
        // 获取原始面试数据
        async function getRawInterviewData() {
            const resultDiv = document.getElementById('rawDataResult');
            resultDiv.style.display = 'block';
            
            if (!authToken) {
                resultDiv.className = 'result-area error';
                resultDiv.textContent = '❌ 请先登录获取Token';
                return;
            }
            
            resultDiv.textContent = '🔄 正在获取面试记录...';
            
            try {
                const response = await fetch('http://localhost:5001/api/v1/interviews?page=1&per_page=50', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.className = 'result-area success';
                    resultDiv.textContent = `✅ 获取成功！共 ${data.data.sessions.length} 条记录\n\n` + 
                        JSON.stringify(data.data, null, 2);
                } else {
                    resultDiv.className = 'result-area error';
                    resultDiv.textContent = `❌ 获取失败: ${data.message || '未知错误'}`;
                }
            } catch (error) {
                resultDiv.className = 'result-area error';
                resultDiv.textContent = `❌ 获取异常: ${error.message}`;
            }
        }
        
        // 测试类型转换逻辑
        function testTypeConversion() {
            const resultDiv = document.getElementById('conversionResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-area success';
            
            // 复制前端的转换逻辑
            const convertInterviewType = (type) => {
                const cleanType = type.includes('.') ? type.split('.').pop()?.toLowerCase() : type.toLowerCase();
                
                switch (cleanType) {
                    case 'mock':
                        return 'Mock Interview';
                    case 'technical':
                    case 'hr':
                    case 'comprehensive':
                        return 'Formal interview';
                    default:
                        return 'Mock Interview';
                }
            };
            
            const testCases = [
                'mock',
                'InterviewType.MOCK',
                'comprehensive',
                'InterviewType.COMPREHENSIVE',
                'technical',
                'unknown'
            ];
            
            let result = '🧪 类型转换测试结果:\n\n';
            testCases.forEach(testCase => {
                const converted = convertInterviewType(testCase);
                result += `输入: "${testCase}" → 输出: "${converted}"\n`;
            });
            
            resultDiv.textContent = result;
        }
        
        // 获取格式化记录
        async function getFormattedRecords() {
            const resultDiv = document.getElementById('formattedResult');
            resultDiv.style.display = 'block';
            
            if (!authToken) {
                resultDiv.className = 'result-area error';
                resultDiv.textContent = '❌ 请先登录获取Token';
                return;
            }
            
            resultDiv.textContent = '🔄 正在获取并格式化记录...';
            
            try {
                const response = await fetch('http://localhost:5001/api/v1/interviews?page=1&per_page=50', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const convertInterviewType = (type) => {
                        const cleanType = type.includes('.') ? type.split('.').pop()?.toLowerCase() : type.toLowerCase();
                        switch (cleanType) {
                            case 'mock': return 'Mock Interview';
                            case 'technical':
                            case 'hr':
                            case 'comprehensive': return 'Formal interview';
                            default: return 'Mock Interview';
                        }
                    };
                    
                    const formatDate = (dateString) => {
                        const date = new Date(dateString);
                        return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                    };
                    
                    const formatDuration = (startTime, endTime) => {
                        if (!endTime) return '未完成';
                        const start = new Date(startTime);
                        const end = new Date(endTime);
                        const diffMs = end.getTime() - start.getTime();
                        const minutes = Math.floor(diffMs / 60000);
                        const seconds = Math.floor((diffMs % 60000) / 1000);
                        return minutes > 0 ? `${minutes}min ${seconds}sec` : `${seconds}sec`;
                    };
                    
                    const formattedRecords = data.data.sessions.map(session => ({
                        id: session.session_id,
                        title: session.title || `${session.interview_type} Interview`,
                        date: formatDate(session.created_at),
                        duration: formatDuration(session.started_at || session.created_at, session.completed_at),
                        type: convertInterviewType(session.interview_type),
                        status: session.status,
                        raw_type: session.interview_type,
                        session
                    }));
                    
                    resultDiv.className = 'result-area success';
                    let result = `✅ 格式化成功！共 ${formattedRecords.length} 条记录\n\n`;
                    
                    formattedRecords.forEach((record, index) => {
                        result += `${index + 1}. ${record.title}\n`;
                        result += `   ID: ${record.id}\n`;
                        result += `   原始类型: ${record.raw_type}\n`;
                        result += `   显示类型: ${record.type}\n`;
                        result += `   状态: ${record.status}\n`;
                        result += `   日期: ${record.date}\n`;
                        result += `   时长: ${record.duration}\n\n`;
                    });
                    
                    resultDiv.textContent = result;
                } else {
                    resultDiv.className = 'result-area error';
                    resultDiv.textContent = `❌ 获取失败: ${data.message || '未知错误'}`;
                }
            } catch (error) {
                resultDiv.className = 'result-area error';
                resultDiv.textContent = `❌ 获取异常: ${error.message}`;
            }
        }
        
        // 验证目标会话
        async function verifyTargetSession() {
            const resultDiv = document.getElementById('targetResult');
            resultDiv.style.display = 'block';
            
            if (!authToken) {
                resultDiv.className = 'result-area error';
                resultDiv.textContent = '❌ 请先登录获取Token';
                return;
            }
            
            const targetSessionId = 'ac5545af-1d34-41e5-b1da-e5fffa0bcacd';
            resultDiv.textContent = `🔄 正在验证目标会话 ${targetSessionId}...`;
            
            try {
                const response = await fetch('http://localhost:5001/api/v1/interviews?page=1&per_page=50', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const targetSession = data.data.sessions.find(s => s.session_id === targetSessionId);
                    
                    if (targetSession) {
                        const convertInterviewType = (type) => {
                            const cleanType = type.includes('.') ? type.split('.').pop()?.toLowerCase() : type.toLowerCase();
                            switch (cleanType) {
                                case 'mock': return 'Mock Interview';
                                case 'technical':
                                case 'hr':
                                case 'comprehensive': return 'Formal interview';
                                default: return 'Mock Interview';
                            }
                        };
                        
                        const displayType = convertInterviewType(targetSession.interview_type);
                        
                        resultDiv.className = 'result-area success';
                        resultDiv.textContent = `🎯 目标会话验证结果:\n\n` +
                            `会话ID: ${targetSession.session_id}\n` +
                            `标题: ${targetSession.title}\n` +
                            `原始类型: ${targetSession.interview_type}\n` +
                            `显示类型: ${displayType}\n` +
                            `状态: ${targetSession.status}\n` +
                            `创建时间: ${targetSession.created_at}\n` +
                            `开始时间: ${targetSession.started_at}\n` +
                            `完成时间: ${targetSession.completed_at}\n\n` +
                            `✅ 验证结果:\n` +
                            `类型显示正确: ${displayType === 'Mock Interview' ? '✅ 是' : '❌ 否'}\n` +
                            `状态正确: ${targetSession.status === 'abandoned' ? '✅ 是' : '❌ 否'}`;
                    } else {
                        resultDiv.className = 'result-area error';
                        resultDiv.textContent = `❌ 未找到目标会话 ${targetSessionId}`;
                    }
                } else {
                    resultDiv.className = 'result-area error';
                    resultDiv.textContent = `❌ 获取失败: ${data.message || '未知错误'}`;
                }
            } catch (error) {
                resultDiv.className = 'result-area error';
                resultDiv.textContent = `❌ 验证异常: ${error.message}`;
            }
        }
        
        // 页面加载时的提示
        window.addEventListener('load', () => {
            console.log('🎯 面试记录显示修复验证页面已加载');
            console.log('请按顺序执行测试：1. 登录 → 2. 获取原始数据 → 3. 测试转换 → 4. 格式化记录 → 5. 验证目标会话');
        });
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ  HomePage Mock Interview Flow Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ  HomePage Mock Interview Flow Test</h1>
        <p>æµ‹è¯•HomePageä¸­Mock Interviewçš„å®Œæ•´æµç¨‹ï¼ˆæ¨¡æ‹Ÿç”¨æˆ·é€‰æ‹©jobåçš„æµç¨‹ï¼‰</p>

        <!-- æµ‹è¯•1: æ¨¡æ‹ŸHomePageçš„Mock Interviewæµç¨‹ -->
        <div class="test-section">
            <h3>ğŸ¯ 1. å®Œæ•´Mock Interviewæµç¨‹æµ‹è¯•</h3>
            <p>æ¨¡æ‹Ÿï¼šé€‰æ‹©job â†’ åˆ›å»ºä¼šè¯ â†’ ç”Ÿæˆé—®é¢˜ â†’ å¯¼èˆªåˆ°MockInterviewPage</p>
            <button onclick="testHomePageMockFlow()">ğŸ§ª æµ‹è¯•HomePageæµç¨‹</button>
            <div id="homePageFlowResult"></div>
        </div>

        <!-- æµ‹è¯•2: éªŒè¯jobå·²æœ‰resume_idçš„æƒ…å†µ -->
        <div class="test-section">
            <h3>ğŸ“‹ 2. Job Resumeå…³è”æµ‹è¯•</h3>
            <p>éªŒè¯jobåˆ—è¡¨ä¸­çš„jobæ˜¯å¦éƒ½æœ‰resume_id</p>
            <button onclick="testJobResumeAssociation()">ğŸ” æ£€æŸ¥Job-Resumeå…³è”</button>
            <div id="jobResumeResult"></div>
        </div>

        <!-- æµ‹è¯•3: å¯¹æ¯”æ–°æ—§æµç¨‹ -->
        <div class="test-section">
            <h3>âš–ï¸ 3. æµç¨‹å¯¹æ¯”æµ‹è¯•</h3>
            <p>å¯¹æ¯”ä¿®å¤å‰åçš„æµç¨‹å·®å¼‚</p>
            <button onclick="compareFlows()">ğŸ“Š å¯¹æ¯”æµç¨‹</button>
            <div id="flowComparisonResult"></div>
        </div>

        <div id="globalResults"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001/api/v1';
        let currentToken = null;

        // è·å–è®¤è¯token
        async function getAuthToken() {
            if (currentToken) return currentToken;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: '3938930977@qq.com',
                        password: '12345678'
                    })
                });
                const data = await response.json();
                currentToken = data.data.access_token;
                return currentToken;
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                throw error;
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<pre>${message}</pre>`;
            element.appendChild(resultDiv);
        }

        // æµ‹è¯•1: æ¨¡æ‹ŸHomePageçš„Mock Interviewæµç¨‹
        async function testHomePageMockFlow() {
            try {
                const token = await getAuthToken();
                let result = 'ğŸ  å¼€å§‹HomePage Mock Interviewæµç¨‹æµ‹è¯•...\n\n';
                
                // 1. è·å–jobåˆ—è¡¨ï¼ˆæ¨¡æ‹ŸHomePageçš„jobåˆ—è¡¨ï¼‰
                const jobsResponse = await fetch(`${API_BASE}/jobs?per_page=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const jobsData = await jobsResponse.json();
                const jobs = jobsData.data?.jobs || [];
                
                if (jobs.length === 0) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„job');
                }
                
                const selectedJob = jobs[0]; // é€‰æ‹©ç¬¬ä¸€ä¸ªjob
                result += `ğŸ“‹ é€‰æ‹©çš„Job: ${selectedJob.title} @ ${selectedJob.company}\n`;
                result += `   Job ID: ${selectedJob.id}\n`;
                result += `   Resume ID: ${selectedJob.resume_id || 'æ— '}\n\n`;
                
                // 2. è·å–å…³è”çš„resumeï¼ˆæ¨¡æ‹ŸHomePageçš„é€»è¾‘ï¼‰
                let resumeId = selectedJob.resume_id;
                
                if (!resumeId) {
                    result += 'âš ï¸ Jobæ²¡æœ‰å…³è”resumeï¼Œè·å–ç”¨æˆ·ç¬¬ä¸€ä¸ªå·²å¤„ç†ç®€å†...\n';
                    const resumesResponse = await fetch(`${API_BASE}/resumes`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const resumesData = await resumesResponse.json();
                    const allResumes = resumesData.data?.resumes || [];
                    const processedResumes = allResumes.filter(r => r.status === 'processed');
                    
                    if (processedResumes.length === 0) {
                        throw new Error('æ²¡æœ‰å·²å¤„ç†çš„ç®€å†');
                    }
                    
                    resumeId = processedResumes[0].id;
                    result += `   ä½¿ç”¨ç®€å†ID: ${resumeId}\n\n`;
                } else {
                    result += `âœ… Jobå·²å…³è”ç®€å†ID: ${resumeId}\n\n`;
                }
                
                // 3. åˆ›å»ºé¢è¯•ä¼šè¯ï¼ˆæ¨¡æ‹ŸHomePageçš„createInterviewï¼‰
                result += 'ğŸš€ åˆ›å»ºMock Interviewä¼šè¯...\n';
                const createResponse = await fetch(`${API_BASE}/interviews`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resume_id: resumeId,
                        interview_type: 'comprehensive',
                        total_questions: 8,
                        custom_title: `${selectedJob.title} @ ${selectedJob.company} Mock Interview`
                    })
                });
                const createData = await createResponse.json();
                
                if (!createData.success) {
                    throw new Error(`åˆ›å»ºé¢è¯•ä¼šè¯å¤±è´¥: ${createData.message}`);
                }
                
                const sessionId = createData.data.session_id;
                result += `âœ… ä¼šè¯åˆ›å»ºæˆåŠŸ: ${sessionId}\n`;
                result += `   çŠ¶æ€: ${createData.data.session.status}\n\n`;
                
                // 4. ç”Ÿæˆé—®é¢˜ï¼ˆæ¨¡æ‹ŸHomePageçš„generateQuestionsï¼‰
                result += 'ğŸ”„ ç”Ÿæˆé¢è¯•é—®é¢˜...\n';
                const generateResponse = await fetch(`${API_BASE}/questions/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resume_id: resumeId,
                        session_id: sessionId,
                        total_questions: 8,
                        interview_type: 'comprehensive'
                    })
                });
                const generateData = await generateResponse.json();
                
                if (!generateData.success) {
                    throw new Error(`ç”Ÿæˆé—®é¢˜å¤±è´¥: ${generateData.message}`);
                }
                
                result += `âœ… é—®é¢˜ç”ŸæˆæˆåŠŸ: ${generateData.questions?.length || 0} ä¸ªé—®é¢˜\n\n`;
                
                // 5. æ£€æŸ¥ä¼šè¯çŠ¶æ€
                const sessionResponse = await fetch(`${API_BASE}/interviews/${sessionId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const sessionData = await sessionResponse.json();
                result += `ğŸ“Š å½“å‰ä¼šè¯çŠ¶æ€: ${sessionData.data.session.status}\n`;
                result += `   é—®é¢˜æ•°é‡: ${sessionData.data.questions?.length || 0}\n\n`;
                
                // 6. å°è¯•å¯åŠ¨é¢è¯•ï¼ˆæ¨¡æ‹ŸMockInterviewPageçš„startInterviewï¼‰
                result += 'ğŸ¬ å°è¯•å¯åŠ¨é¢è¯•...\n';
                const startResponse = await fetch(`${API_BASE}/interviews/${sessionId}/start`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const startData = await startResponse.json();
                
                if (startData.success) {
                    result += `âœ… é¢è¯•å¯åŠ¨æˆåŠŸ!\n`;
                    result += `   æœ€ç»ˆçŠ¶æ€: ${startData.data.session.status}\n`;
                    result += `   å¯åŠ¨æ—¶é—´: ${startData.data.session.started_at}\n\n`;
                    result += `ğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸ! ç°åœ¨ç”¨æˆ·å¯ä»¥æ­£å¸¸è¿›è¡ŒMock Interviewäº†ã€‚`;
                    showResult('homePageFlowResult', result, 'success');
                } else {
                    result += `âŒ é¢è¯•å¯åŠ¨å¤±è´¥: ${startData.message}\n`;
                    showResult('homePageFlowResult', result, 'error');
                }
                
            } catch (error) {
                showResult('homePageFlowResult', `âŒ HomePageæµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•2: éªŒè¯jobå·²æœ‰resume_idçš„æƒ…å†µ
        async function testJobResumeAssociation() {
            try {
                const token = await getAuthToken();
                let result = 'ğŸ“‹ æ£€æŸ¥Job-Resumeå…³è”æƒ…å†µ...\n\n';
                
                // è·å–æ‰€æœ‰jobs
                const jobsResponse = await fetch(`${API_BASE}/jobs?per_page=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const jobsData = await jobsResponse.json();
                const jobs = jobsData.data?.jobs || [];
                
                result += `ğŸ“Š æ€»å…±æ‰¾åˆ° ${jobs.length} ä¸ªJob:\n\n`;
                
                let hasResumeCount = 0;
                let noResumeCount = 0;
                
                jobs.forEach((job, index) => {
                    result += `${index + 1}. "${job.title}" @ ${job.company}\n`;
                    result += `   Job ID: ${job.id}\n`;
                    if (job.resume_id) {
                        result += `   âœ… Resume ID: ${job.resume_id}\n`;
                        hasResumeCount++;
                    } else {
                        result += `   âŒ æ— å…³è”Resume\n`;
                        noResumeCount++;
                    }
                    result += '\n';
                });
                
                result += `ğŸ“ˆ ç»Ÿè®¡ç»“æœ:\n`;
                result += `   æœ‰Resumeå…³è”: ${hasResumeCount} ä¸ª\n`;
                result += `   æ— Resumeå…³è”: ${noResumeCount} ä¸ª\n\n`;
                
                if (noResumeCount > 0) {
                    result += `âš ï¸ å‘ç° ${noResumeCount} ä¸ªJobæ²¡æœ‰å…³è”Resumeï¼Œè¿™äº›Jobåœ¨Mock Interviewæ—¶ä¼šä½¿ç”¨ç”¨æˆ·çš„ç¬¬ä¸€ä¸ªå·²å¤„ç†ç®€å†ã€‚`;
                    showResult('jobResumeResult', result, 'warning');
                } else {
                    result += `ğŸ‰ æ‰€æœ‰Jobéƒ½å·²æ­£ç¡®å…³è”Resumeï¼`;
                    showResult('jobResumeResult', result, 'success');
                }
                
            } catch (error) {
                showResult('jobResumeResult', `âŒ Job-Resumeå…³è”æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•3: å¯¹æ¯”æ–°æ—§æµç¨‹
        async function compareFlows() {
            let result = 'âš–ï¸ Mock Interviewæµç¨‹å¯¹æ¯”åˆ†æ\n\n';
            
            result += 'ğŸ”´ ä¿®å¤å‰çš„é”™è¯¯æµç¨‹:\n';
            result += '1. HomePage â†’ é€‰æ‹©Job â†’ ç‚¹å‡»"Start Interview"\n';
            result += '2. HomePage â†’ åˆ›å»ºé¢è¯•ä¼šè¯ï¼ˆçŠ¶æ€: createdï¼‰\n';
            result += '3. HomePage â†’ ç›´æ¥è·³è½¬åˆ°MockInterviewPageï¼ˆâŒ æ²¡æœ‰ç”Ÿæˆé—®é¢˜ï¼‰\n';
            result += '4. MockInterviewPage â†’ å‘ç°æ²¡æœ‰é—®é¢˜ â†’ è°ƒç”¨startInterview\n';
            result += '5. startInterview API â†’ 400é”™è¯¯ï¼ˆä¼šè¯çŠ¶æ€å¯èƒ½å·²ç»æ˜¯in_progressï¼‰\n\n';
            
            result += 'ğŸŸ¢ ä¿®å¤åçš„æ­£ç¡®æµç¨‹:\n';
            result += '1. HomePage â†’ é€‰æ‹©Job â†’ ç‚¹å‡»"Start Interview"\n';
            result += '2. HomePage â†’ åˆ›å»ºé¢è¯•ä¼šè¯ï¼ˆçŠ¶æ€: createdï¼‰\n';
            result += '3. HomePage â†’ ç”Ÿæˆé¢è¯•é—®é¢˜ï¼ˆçŠ¶æ€: readyï¼‰\n';
            result += '4. HomePage â†’ è·³è½¬åˆ°MockInterviewPageï¼ˆæºå¸¦questionsæ•°æ®ï¼‰\n';
            result += '5. MockInterviewPage â†’ æœ‰é—®é¢˜æ•°æ® â†’ æ­£å¸¸å¯åŠ¨é¢è¯•\n\n';
            
            result += 'ğŸ”§ å…³é”®ä¿®å¤ç‚¹:\n';
            result += 'â€¢ åœ¨HomePageä¸­æ·»åŠ äº†é—®é¢˜ç”Ÿæˆæ­¥éª¤\n';
            result += 'â€¢ ç¡®ä¿è·³è½¬æ—¶æºå¸¦questionsæ•°æ®\n';
            result += 'â€¢ åç«¯æ”¯æŒin_progressçŠ¶æ€çš„é‡å¤å¯åŠ¨\n';
            result += 'â€¢ å‰ç«¯ä¼˜åŒ–äº†çŠ¶æ€å¤„ç†é€»è¾‘\n\n';
            
            result += 'âœ… ä¿®å¤æ•ˆæœ:\n';
            result += 'â€¢ ç”¨æˆ·é€‰æ‹©Jobåèƒ½ç«‹å³å¼€å§‹é¢è¯•\n';
            result += 'â€¢ ä¸å†å‡ºç°400é”™è¯¯\n';
            result += 'â€¢ æµç¨‹æ›´åŠ é¡ºç•…å’Œç›´è§‚\n';
            result += 'â€¢ æ­£ç¡®åˆ©ç”¨Jobå·²æœ‰çš„resume_idå…³è”';
            
            showResult('flowComparisonResult', result, 'info');
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
        window.onload = function() {
            showResult('globalResults', 
                'ğŸ  HomePage Mock Interviewæµç¨‹æµ‹è¯•é¡µé¢\n' +
                'ğŸ“‹ æµ‹è¯•ç›®æ ‡:\n' +
                '  éªŒè¯ç”¨æˆ·ä»HomePageé€‰æ‹©Jobå¼€å§‹Mock Interviewçš„å®Œæ•´æµç¨‹\n\n' +
                'ğŸ¯ å…³é”®éªŒè¯ç‚¹:\n' +
                '  1. Jobæ˜¯å¦æ­£ç¡®å…³è”Resume\n' +
                '  2. é¢è¯•ä¼šè¯åˆ›å»ºæ˜¯å¦æˆåŠŸ\n' +
                '  3. é—®é¢˜ç”Ÿæˆæ˜¯å¦æ­£å¸¸\n' +
                '  4. é¢è¯•å¯åŠ¨æ˜¯å¦æ— é”™è¯¯\n\n' +
                'ğŸ”§ ä¿®å¤å†…å®¹:\n' +
                '  HomePageç°åœ¨ä¼šåœ¨åˆ›å»ºä¼šè¯åç«‹å³ç”Ÿæˆé—®é¢˜ï¼Œ\n' +
                '  ç¡®ä¿MockInterviewPageæœ‰å®Œæ•´çš„æ•°æ®è¿›è¡Œé¢è¯•\n\n' +
                'ğŸ‘† ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•', 
                'info'
            );
        };
    </script>
</body>
</html> 
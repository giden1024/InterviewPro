<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å†è§£æJSONæ˜¾ç¤ºæµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .json-viewer {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        .json-key { color: #9cdcfe; }
        .json-string { color: #ce9178; }
        .json-number { color: #b5cea8; }
        .json-boolean { color: #569cd6; }
        .json-null { color: #569cd6; }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
        }
        .tab-button:not(.active):hover {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">
                ğŸ“„ ç®€å†è§£æ JSON æ˜¾ç¤ºæµ‹è¯•
            </h1>

            <!-- æœåŠ¡å™¨é€‰æ‹© -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">ğŸ”§ æœåŠ¡å™¨é€‰æ‹©</h2>
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="server" value="localhost:5002" checked class="mr-2">
                        <span class="text-sm">æµ‹è¯•æœåŠ¡å™¨ (localhost:5002) - æ— éœ€è®¤è¯</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="server" value="localhost:5001" class="mr-2">
                        <span class="text-sm">ä¸»æœåŠ¡å™¨ (localhost:5001) - éœ€è¦è®¤è¯</span>
                    </label>
                </div>
            </div>

            <!-- æ–‡ä»¶æµ‹è¯•åŒºåŸŸ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">ğŸ“ é¢„å®šä¹‰æ–‡ä»¶æµ‹è¯•</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button onclick="testFile('é™ˆç†™è•¾.docx')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        é™ˆç†™è•¾.docx
                    </button>
                    <button onclick="testFile('app_cv.pdf')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        app_cv.pdf
                    </button>
                    <button onclick="testFile('resume.docx')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        resume.docx
                    </button>
                    <button onclick="testFile('åˆ˜å©§å“² Ven.docx')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        åˆ˜å©§å“² Ven.docx
                    </button>
                </div>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">ğŸ“¤ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h2>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <input type="file" id="fileInput" accept=".pdf,.doc,.docx" class="flex-1 border border-gray-300 rounded px-3 py-2">
                    <button onclick="uploadFile()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded transition-colors">
                        ä¸Šä¼ å¹¶è§£æ
                    </button>
                </div>
            </div>

            <!-- è®¤è¯åŒºåŸŸ -->
            <div id="authSection" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 hidden">
                <h3 class="font-semibold text-yellow-800 mb-2">ğŸ” éœ€è¦ç™»å½•è®¤è¯</h3>
                <div class="flex gap-2">
                    <button onclick="createTestUser()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        åˆ›å»ºæµ‹è¯•ç”¨æˆ·
                    </button>
                    <button onclick="login()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        ç™»å½•
                    </button>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="border-b border-gray-200">
                    <nav class="flex">
                        <button onclick="switchTab('formatted')" class="tab-button active px-6 py-3 text-sm font-medium border-r border-gray-200">
                            ğŸ“‹ æ ¼å¼åŒ–æ˜¾ç¤º
                        </button>
                        <button onclick="switchTab('json')" class="tab-button px-6 py-3 text-sm font-medium border-r border-gray-200">
                            ğŸ”¤ åŸå§‹JSON
                        </button>
                        <button onclick="switchTab('debug')" class="tab-button px-6 py-3 text-sm font-medium">
                            ğŸ› è°ƒè¯•ä¿¡æ¯
                        </button>
                    </nav>
                </div>

                <div class="p-6">
                    <!-- æ ¼å¼åŒ–æ˜¾ç¤ºæ ‡ç­¾é¡µ -->
                    <div id="formattedTab" class="tab-content">
                        <div id="results" class="text-gray-600">
                            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æµ‹è¯•æ–‡ä»¶è§£æ...
                        </div>
                    </div>

                    <!-- JSONæ ‡ç­¾é¡µ -->
                    <div id="jsonTab" class="tab-content hidden">
                        <div class="mb-4">
                            <button onclick="copyJson()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm transition-colors">
                                ğŸ“‹ å¤åˆ¶JSON
                            </button>
                            <button onclick="downloadJson()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm ml-2 transition-colors">
                                ğŸ’¾ ä¸‹è½½JSON
                            </button>
                        </div>
                        <div id="jsonViewer" class="json-viewer">
                            æš‚æ— JSONæ•°æ®
                        </div>
                    </div>

                    <!-- è°ƒè¯•ä¿¡æ¯æ ‡ç­¾é¡µ -->
                    <div id="debugTab" class="tab-content hidden">
                        <div id="debugInfo" class="bg-gray-100 p-4 rounded text-sm font-mono">
                            æš‚æ— è°ƒè¯•ä¿¡æ¯
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentJson = null;
        let debugLogs = [];

        // è·å–å½“å‰é€‰æ‹©çš„æœåŠ¡å™¨
        function getSelectedServer() {
            return document.querySelector('input[name="server"]:checked').value;
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            // æ˜¾ç¤ºé€‰æ‹©çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            event.target.classList.add('active');
        }

        // è®°å½•è°ƒè¯•ä¿¡æ¯
        function addDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            document.getElementById('debugInfo').textContent = debugLogs.join('\n');
        }

        // ç›‘å¬æœåŠ¡å™¨é€‰æ‹©å˜åŒ–
        document.querySelectorAll('input[name="server"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const authSection = document.getElementById('authSection');
                if (this.value === 'localhost:5001') {
                    authSection.classList.remove('hidden');
                    addDebugLog('åˆ‡æ¢åˆ°ä¸»æœåŠ¡å™¨ï¼Œéœ€è¦è®¤è¯');
                } else {
                    authSection.classList.add('hidden');
                    addDebugLog('åˆ‡æ¢åˆ°æµ‹è¯•æœåŠ¡å™¨ï¼Œæ— éœ€è®¤è¯');
                }
            });
        });

        // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
        async function createTestUser() {
            try {
                addDebugLog('æ­£åœ¨åˆ›å»ºæµ‹è¯•ç”¨æˆ·...');
                const response = await fetch('http://localhost:5001/api/v1/dev/create-test-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*'
                    }
                });
                const result = await response.json();
                addDebugLog(`åˆ›å»ºç”¨æˆ·ç»“æœ: ${JSON.stringify(result)}`);
            } catch (error) {
                addDebugLog(`åˆ›å»ºç”¨æˆ·å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç™»å½•
        async function login() {
            try {
                addDebugLog('æ­£åœ¨ç™»å½•...');
                const response = await fetch('http://localhost:5001/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'test123'
                    })
                });
                const result = await response.json();
                if (result.access_token) {
                    localStorage.setItem('token', result.access_token);
                    addDebugLog('ç™»å½•æˆåŠŸ');
                } else {
                    addDebugLog(`ç™»å½•å¤±è´¥: ${JSON.stringify(result)}`, 'error');
                }
            } catch (error) {
                addDebugLog(`ç™»å½•å‡ºé”™: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•é¢„å®šä¹‰æ–‡ä»¶
        async function testFile(filename) {
            const server = getSelectedServer();
            addDebugLog(`å¼€å§‹æµ‹è¯•æ–‡ä»¶: ${filename}`);

            try {
                let url, options;
                
                if (server === 'localhost:5002') {
                    // æµ‹è¯•æœåŠ¡å™¨
                    url = `http://localhost:5002/test-file/${encodeURIComponent(filename)}`;
                    options = {
                        method: 'POST',
                        headers: {
                            'Access-Control-Allow-Origin': '*'
                        }
                    };
                } else {
                    // ä¸»æœåŠ¡å™¨ - éœ€è¦å…ˆä¸Šä¼ æ–‡ä»¶å†è§£æ
                    addDebugLog('ä¸»æœåŠ¡å™¨æµ‹è¯•åŠŸèƒ½æš‚æœªå®ç°ï¼Œè¯·ä½¿ç”¨æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½');
                    return;
                }

                addDebugLog(`è¯·æ±‚URL: ${url}`);
                const response = await fetch(url, options);
                const result = await response.json();
                
                addDebugLog(`è§£æå®Œæˆï¼ŒçŠ¶æ€: ${response.status}`);
                displayResults(result, filename);
                
            } catch (error) {
                addDebugLog(`æµ‹è¯•æ–‡ä»¶å¤±è´¥: ${error.message}`, 'error');
                displayError(error.message);
            }
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                addDebugLog('è¯·é€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            const server = getSelectedServer();
            addDebugLog(`ä¸Šä¼ æ–‡ä»¶: ${file.name} åˆ° ${server}`);

            try {
                const formData = new FormData();
                formData.append('file', file);

                let url, options;
                
                if (server === 'localhost:5002') {
                    url = 'http://localhost:5002/test-project-extraction';
                    options = {
                        method: 'POST',
                        body: formData
                    };
                } else {
                    url = 'http://localhost:5001/api/v1/resumes';
                    options = {
                        method: 'POST',
                        body: formData
                    };
                    
                    // å¦‚æœæœ‰tokenï¼Œæ·»åŠ è®¤è¯å¤´
                    const token = localStorage.getItem('token');
                    if (token) {
                        options.headers = {
                            'Authorization': `Bearer ${token}`
                        };
                    }
                }

                addDebugLog(`ä¸Šä¼ URL: ${url}`);
                const response = await fetch(url, options);
                const result = await response.json();
                
                addDebugLog(`ä¸Šä¼ å®Œæˆï¼ŒçŠ¶æ€: ${response.status}`);
                displayResults(result, file.name);
                
            } catch (error) {
                addDebugLog(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                displayError(error.message);
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(data, filename) {
            currentJson = data;
            
            // æ›´æ–°æ ¼å¼åŒ–æ˜¾ç¤º
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = formatResults(data, filename);
            
            // æ›´æ–°JSONæ˜¾ç¤º
            const jsonViewer = document.getElementById('jsonViewer');
            jsonViewer.innerHTML = syntaxHighlight(JSON.stringify(data, null, 2));
            
            addDebugLog('ç»“æœæ˜¾ç¤ºå®Œæˆ');
        }

        // æ ¼å¼åŒ–ç»“æœæ˜¾ç¤º
        function formatResults(data, filename) {
            if (!data) return '<div class="text-red-500">âŒ æ— æ•°æ®</div>';

            let html = `<div class="space-y-6">`;
            html += `<div class="border-b border-gray-200 pb-4"><h3 class="text-xl font-bold text-gray-800">ğŸ“„ ${filename}</h3></div>`;

            // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
            if (data.name || data.email || data.phone) {
                html += `<div class="bg-blue-50 p-4 rounded-lg">`;
                html += `<h4 class="font-semibold text-blue-800 mb-2">ğŸ‘¤ åŸºæœ¬ä¿¡æ¯</h4>`;
                html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">`;
                if (data.name) html += `<div><span class="font-medium">å§“å:</span> ${data.name}</div>`;
                if (data.email) html += `<div><span class="font-medium">é‚®ç®±:</span> ${data.email}</div>`;
                if (data.phone) html += `<div><span class="font-medium">ç”µè¯:</span> ${data.phone}</div>`;
                html += `</div></div>`;
            }

            // æ˜¾ç¤ºæŠ€èƒ½
            if (data.skills && data.skills.length > 0) {
                html += `<div class="bg-green-50 p-4 rounded-lg">`;
                html += `<h4 class="font-semibold text-green-800 mb-2">ğŸ”§ æŠ€èƒ½ (${data.skills.length})</h4>`;
                html += `<div class="flex flex-wrap gap-2">`;
                data.skills.forEach(skill => {
                    html += `<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">${skill}</span>`;
                });
                html += `</div></div>`;
            }

            // æ˜¾ç¤ºå·¥ä½œç»å†
            if (data.experience && data.experience.length > 0) {
                html += `<div class="bg-purple-50 p-4 rounded-lg">`;
                html += `<h4 class="font-semibold text-purple-800 mb-3">ğŸ’¼ å·¥ä½œç»å† (${data.experience.length})</h4>`;
                html += `<div class="space-y-3">`;
                data.experience.forEach((exp, index) => {
                    html += `<div class="bg-white p-3 rounded border-l-4 border-purple-400">`;
                    html += `<div class="font-medium text-gray-800">${exp.position || 'èŒä½æœªçŸ¥'}</div>`;
                    if (exp.company) html += `<div class="text-sm text-gray-600">${exp.company}</div>`;
                    if (exp.duration) html += `<div class="text-sm text-gray-500">${exp.duration}</div>`;
                    if (exp.location) html += `<div class="text-sm text-gray-500">ğŸ“ ${exp.location}</div>`;
                    if (exp.description) html += `<div class="text-sm text-gray-700 mt-2">${exp.description}</div>`;
                    html += `</div>`;
                });
                html += `</div></div>`;
            }

            // æ˜¾ç¤ºæ•™è‚²èƒŒæ™¯
            if (data.education && data.education.length > 0) {
                html += `<div class="bg-yellow-50 p-4 rounded-lg">`;
                html += `<h4 class="font-semibold text-yellow-800 mb-3">ğŸ“ æ•™è‚²èƒŒæ™¯ (${data.education.length})</h4>`;
                html += `<div class="space-y-3">`;
                data.education.forEach((edu, index) => {
                    html += `<div class="bg-white p-3 rounded border-l-4 border-yellow-400">`;
                    if (edu.institution) html += `<div class="font-medium text-gray-800">${edu.institution}</div>`;
                    if (edu.degree) html += `<div class="text-sm text-gray-600">${edu.degree}</div>`;
                    if (edu.duration) html += `<div class="text-sm text-gray-500">${edu.duration}</div>`;
                    if (edu.gpa) html += `<div class="text-sm text-gray-500">GPA: ${edu.gpa}</div>`;
                    if (edu.location) html += `<div class="text-sm text-gray-500">ğŸ“ ${edu.location}</div>`;
                    html += `</div>`;
                });
                html += `</div></div>`;
            }

            // æ˜¾ç¤ºé¡¹ç›®ç»å†
            if (data.projects && data.projects.length > 0) {
                html += `<div class="bg-indigo-50 p-4 rounded-lg">`;
                html += `<h4 class="font-semibold text-indigo-800 mb-3">ğŸš€ é¡¹ç›®ç»å† (${data.projects.length})</h4>`;
                html += `<div class="space-y-3">`;
                data.projects.forEach((project, index) => {
                    html += `<div class="bg-white p-3 rounded border-l-4 border-indigo-400">`;
                    html += `<div class="font-medium text-gray-800">${project.name || `é¡¹ç›® ${index + 1}`}</div>`;
                    if (project.description) html += `<div class="text-sm text-gray-700 mt-1">${project.description}</div>`;
                    if (project.technologies && project.technologies.length > 0) {
                        html += `<div class="flex flex-wrap gap-1 mt-2">`;
                        project.technologies.forEach(tech => {
                            html += `<span class="bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded text-xs">${tech}</span>`;
                        });
                        html += `</div>`;
                    }
                    html += `</div>`;
                });
                html += `</div></div>`;
            }

            // æ˜¾ç¤ºè§£æçŠ¶æ€
            const success = data.success !== undefined ? data.success : true;
            html += `<div class="bg-gray-50 p-4 rounded-lg">`;
            html += `<h4 class="font-semibold text-gray-800 mb-2">ğŸ“Š è§£æçŠ¶æ€</h4>`;
            html += `<div class="text-sm">`;
            html += `<div class="flex items-center gap-2">`;
            html += success ? 
                `<span class="text-green-600">âœ… è§£ææˆåŠŸ</span>` : 
                `<span class="text-red-600">âŒ è§£æå¤±è´¥</span>`;
            html += `</div>`;
            if (data.error) html += `<div class="text-red-600 mt-1">é”™è¯¯: ${data.error}</div>`;
            html += `</div></div>`;

            html += `</div>`;
            return html;
        }

        // æ˜¾ç¤ºé”™è¯¯
        function displayError(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div class="text-red-500 bg-red-50 p-4 rounded-lg">âŒ é”™è¯¯: ${message}</div>`;
            
            document.getElementById('jsonViewer').textContent = 'è§£æå¤±è´¥ï¼Œæ— JSONæ•°æ®';
        }

        // JSONè¯­æ³•é«˜äº®
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // å¤åˆ¶JSON
        function copyJson() {
            if (!currentJson) {
                addDebugLog('æ— JSONæ•°æ®å¯å¤åˆ¶', 'error');
                return;
            }
            
            navigator.clipboard.writeText(JSON.stringify(currentJson, null, 2)).then(() => {
                addDebugLog('JSONå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ–‡å­—
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²å¤åˆ¶';
                btn.className = btn.className.replace('bg-gray-500', 'bg-green-500');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.className = btn.className.replace('bg-green-500', 'bg-gray-500');
                }, 2000);
            }).catch(err => {
                addDebugLog(`å¤åˆ¶å¤±è´¥: ${err.message}`, 'error');
            });
        }

        // ä¸‹è½½JSON
        function downloadJson() {
            if (!currentJson) {
                addDebugLog('æ— JSONæ•°æ®å¯ä¸‹è½½', 'error');
                return;
            }
            
            const dataStr = JSON.stringify(currentJson, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `resume-parse-result-${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            addDebugLog('JSONæ–‡ä»¶ä¸‹è½½å¼€å§‹');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addDebugLog('é¡µé¢åŠ è½½å®Œæˆ');
            addDebugLog('å½“å‰é…ç½®: æµ‹è¯•æœåŠ¡å™¨ localhost:5002');
        });
    </script>
</body>
</html> 
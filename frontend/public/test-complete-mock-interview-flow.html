<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Mock Interview Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        #results { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; white-space: pre-wrap; }
        .step { margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>ğŸ¯ Complete Mock Interview Flow Test</h1>
    
    <div class="test-section">
        <h3>æµ‹è¯•è¯´æ˜ï¼š</h3>
        <p>æ¨¡æ‹Ÿç”¨æˆ·ä»HomePageç‚¹å‡»Mock Interviewï¼Œé€‰æ‹©Marketing Plannerçš„å®Œæ•´æµç¨‹</p>
        <ul>
            <li>âœ… ç™»å½•ç”¨æˆ·ï¼š3938930977@qq.com</li>
            <li>âœ… è·å–ç”¨æˆ·ç®€å†</li>
            <li>âœ… åˆ›å»ºé¢è¯•ä¼šè¯</li>
            <li>âœ… ç”Ÿæˆé—®é¢˜</li>
            <li>ğŸ” <strong>æµ‹è¯•startInterviewè°ƒç”¨ï¼ˆé‡ç‚¹ï¼‰</strong></li>
        </ul>
    </div>
    
    <button class="btn-primary" onclick="runCompleteTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
    <button class="btn-success" onclick="clearResults()">ğŸ§¹ æ¸…ç©ºç»“æœ</button>
    
    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:5001/api/v1';
        let testResults = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testResults.push(logMessage);
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = testResults.join('\n');
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            
            console.log(logMessage);
        }
        
        function clearResults() {
            testResults = [];
            document.getElementById('results').innerHTML = '';
        }
        
        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const response = await fetch(url, options);
            const data = await response.json();
            
            log(`API: ${options.method || 'GET'} ${endpoint} -> ${response.status}`, 
                response.ok ? 'success' : 'error');
                
            if (!response.ok) {
                log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(data)}`, 'error');
            }
            
            return { response, data };
        }
        
        async function runCompleteTest() {
            try {
                clearResults();
                log('ğŸ¯ å¼€å§‹å®Œæ•´Mock Interviewæµç¨‹æµ‹è¯•', 'info');
                
                // Step 1: ç™»å½•
                log('\nğŸ“ Step 1: ç”¨æˆ·ç™»å½•', 'info');
                const { data: loginData } = await apiCall('/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: '3938930977@qq.com',
                        password: '12345678'
                    })
                });
                
                if (!loginData.success) {
                    throw new Error('ç™»å½•å¤±è´¥: ' + loginData.message);
                }
                
                const token = loginData.data.access_token;
                log('âœ… ç™»å½•æˆåŠŸï¼Œè·å–token', 'success');
                
                // Step 2: è·å–ç®€å†
                log('\nğŸ“„ Step 2: è·å–ç”¨æˆ·ç®€å†', 'info');
                const { data: resumesData } = await apiCall('/resumes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const resumes = resumesData.data?.resumes || resumesData.resumes || [];
                const processedResume = resumes.find(r => r.status === 'processed');
                
                if (!processedResume) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°å·²å¤„ç†çš„ç®€å†');
                }
                
                log(`âœ… æ‰¾åˆ°å·²å¤„ç†ç®€å†: ID=${processedResume.id}`, 'success');
                
                // Step 3: åˆ›å»ºé¢è¯•ä¼šè¯ï¼ˆæ¨¡æ‹Ÿé€‰æ‹©Marketing Plannerï¼‰
                log('\nğŸ¯ Step 3: åˆ›å»ºMock Interviewä¼šè¯', 'info');
                const { data: interviewData } = await apiCall('/interviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        resume_id: processedResume.id,
                        interview_type: 'mock',
                        total_questions: 5,
                        difficulty_distribution: {
                            'easy': 2,
                            'medium': 2,
                            'hard': 1
                        },
                        type_distribution: {
                            'behavioral': 2,
                            'technical': 2,
                            'situational': 1
                        },
                        custom_title: 'Marketing Planner Mock Interview'
                    })
                });
                
                if (!interviewData.success) {
                    throw new Error('åˆ›å»ºé¢è¯•ä¼šè¯å¤±è´¥: ' + interviewData.message);
                }
                
                const sessionId = interviewData.data.session_id;
                log(`âœ… åˆ›å»ºé¢è¯•ä¼šè¯æˆåŠŸ: ${sessionId}`, 'success');
                
                // Step 4: ç”Ÿæˆé—®é¢˜
                log('\nâ“ Step 4: ç”Ÿæˆé¢è¯•é—®é¢˜', 'info');
                const { data: questionsData } = await apiCall('/questions/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        resume_id: processedResume.id,
                        session_id: sessionId
                    })
                });
                
                if (!questionsData.success) {
                    throw new Error('ç”Ÿæˆé—®é¢˜å¤±è´¥: ' + questionsData.message);
                }
                
                log(`âœ… ç”Ÿæˆé—®é¢˜æˆåŠŸ: ${questionsData.data.questions.length}ä¸ªé—®é¢˜`, 'success');
                log(`ğŸ“Š ä¼šè¯çŠ¶æ€: ${questionsData.data.session.status}`, 'info');
                
                // Step 5: å…³é”®æµ‹è¯• - startInterview
                log('\nğŸš€ Step 5: å¯åŠ¨é¢è¯•ï¼ˆå…³é”®æµ‹è¯•ï¼‰', 'warning');
                log('ğŸ” æµ‹è¯•åœºæ™¯ï¼šæ¨¡æ‹Ÿå‰ç«¯å¯èƒ½çš„é‡å¤è°ƒç”¨', 'info');
                
                // 5a: ç¬¬ä¸€æ¬¡è°ƒç”¨
                log('\nğŸ”„ 5a: ç¬¬ä¸€æ¬¡å¯åŠ¨é¢è¯•è°ƒç”¨', 'info');
                const startResponse1 = await fetch(`${API_BASE}/interviews/${sessionId}/start`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const startData1 = await startResponse1.json();
                log(`ğŸ“Š ç¬¬1æ¬¡è°ƒç”¨: ${startResponse1.status} - ${startData1.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, 
                    startResponse1.status === 200 ? 'success' : 'error');
                
                if (!startData1.success) {
                    log(`âŒ ç¬¬1æ¬¡è°ƒç”¨é”™è¯¯: ${startData1.message || JSON.stringify(startData1)}`, 'error');
                }
                
                // 5b: çŸ­æš‚å»¶è¿Ÿåç¬¬äºŒæ¬¡è°ƒç”¨ï¼ˆæ¨¡æ‹Ÿå‰ç«¯é€»è¾‘ä¸­çš„é‡å¤è°ƒç”¨ï¼‰
                log('\nâ±ï¸ ç­‰å¾…100msåè¿›è¡Œç¬¬äºŒæ¬¡è°ƒç”¨...', 'info');
                await new Promise(resolve => setTimeout(resolve, 100));
                
                log('ğŸ”„ 5b: ç¬¬äºŒæ¬¡å¯åŠ¨é¢è¯•è°ƒç”¨', 'info');
                const startResponse2 = await fetch(`${API_BASE}/interviews/${sessionId}/start`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const startData2 = await startResponse2.json();
                log(`ğŸ“Š ç¬¬2æ¬¡è°ƒç”¨: ${startResponse2.status} - ${startData2.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, 
                    startResponse2.status === 200 ? 'success' : 'warning');
                
                if (!startData2.success) {
                    log(`âš ï¸ ç¬¬2æ¬¡è°ƒç”¨é”™è¯¯: ${startData2.message || JSON.stringify(startData2)}`, 'warning');
                }
                
                // åˆ†æç»“æœ
                log('\nğŸ“ˆ æµ‹è¯•ç»“æœåˆ†æ:', 'info');
                log(`ç¬¬1æ¬¡è°ƒç”¨: ${startResponse1.status}`, 'info');
                log(`ç¬¬2æ¬¡è°ƒç”¨: ${startResponse2.status}`, 'info');
                
                if (startResponse1.status === 200 && startResponse2.status === 400) {
                    log('âœ… å®Œç¾ï¼ç¬¬ä¸€æ¬¡æˆåŠŸï¼Œç¬¬äºŒæ¬¡è¢«æ­£ç¡®é˜»æ­¢ï¼ˆé¢„æœŸè¡Œä¸ºï¼‰', 'success');
                } else if (startResponse1.status === 200 && startResponse2.status === 200) {
                    log('âš ï¸ è­¦å‘Šï¼šä¸¤æ¬¡è°ƒç”¨éƒ½æˆåŠŸäº†ï¼Œå¯èƒ½å­˜åœ¨å¹¶å‘é—®é¢˜', 'warning');
                } else if (startResponse1.status === 400) {
                    log('âŒ é”™è¯¯ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨å°±å¤±è´¥äº†ï¼Œæ£€æŸ¥ä¼šè¯çŠ¶æ€', 'error');
                } else {
                    log('â“ å…¶ä»–æƒ…å†µï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ†æ', 'warning');
                }
                
                // Step 6: éªŒè¯æœ€ç»ˆçŠ¶æ€
                log('\nğŸ” Step 6: éªŒè¯æœ€ç»ˆä¼šè¯çŠ¶æ€', 'info');
                const { data: finalSessionData } = await apiCall(`/interviews/${sessionId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (finalSessionData.success) {
                    log(`ğŸ“Š æœ€ç»ˆä¼šè¯çŠ¶æ€: ${finalSessionData.data.status}`, 'info');
                    log(`ğŸ“Š å¯åŠ¨æ—¶é—´: ${finalSessionData.data.started_at || 'æœªå¯åŠ¨'}`, 'info');
                }
                
                log('\nğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆï¼', 'success');
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•é”™è¯¯å¤„ç†æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .test-button:hover {
            background-color: #0056b3;
        }
        
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç™»å½•é”™è¯¯å¤„ç†æµ‹è¯•</h1>
        
        <div class="info result">
            <strong>æµ‹è¯•è¯´æ˜ï¼š</strong><br>
            è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•å„ç§ç™»å½•é”™è¯¯åœºæ™¯çš„å¤„ç†ï¼ŒéªŒè¯å‰ç«¯èƒ½å¦æ­£ç¡®æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€‚<br>
            <strong>ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ï¼š</strong> <code>./start_backend.sh</code>
        </div>

        <!-- ç”¨æˆ·ä¸å­˜åœ¨æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸš« æµ‹è¯•ï¼šç”¨æˆ·ä¸å­˜åœ¨</h3>
            <p>æµ‹è¯•ä½¿ç”¨ä¸å­˜åœ¨çš„é‚®ç®±ç™»å½•</p>
            <button class="test-button" onclick="testUserNotExists()">æµ‹è¯•ç”¨æˆ·ä¸å­˜åœ¨</button>
            <div id="userNotExistsResult"></div>
        </div>

        <!-- å¯†ç é”™è¯¯æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ”’ æµ‹è¯•ï¼šå¯†ç é”™è¯¯</h3>
            <p>æµ‹è¯•ä½¿ç”¨é”™è¯¯å¯†ç ç™»å½•å·²å­˜åœ¨ç”¨æˆ·</p>
            <button class="test-button" onclick="testWrongPassword()">æµ‹è¯•å¯†ç é”™è¯¯</button>
            <div id="wrongPasswordResult"></div>
        </div>

        <!-- ç½‘ç»œé”™è¯¯æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸŒ æµ‹è¯•ï¼šç½‘ç»œé”™è¯¯</h3>
            <p>æµ‹è¯•ç½‘ç»œè¿æ¥é—®é¢˜</p>
            <button class="test-button" onclick="testNetworkError()">æµ‹è¯•ç½‘ç»œé”™è¯¯</button>
            <div id="networkErrorResult"></div>
        </div>

        <!-- æ­£å¸¸ç™»å½•æµ‹è¯• -->
        <div class="test-section">
            <h3>âœ… æµ‹è¯•ï¼šæ­£å¸¸ç™»å½•</h3>
            <p>æµ‹è¯•ä½¿ç”¨æ­£ç¡®çš„å‡­æ®ç™»å½•</p>
            <button class="test-button" onclick="testSuccessfulLogin()">æµ‹è¯•æ­£å¸¸ç™»å½•</button>
            <div id="successfulLoginResult"></div>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
            <div id="testLog" class="log"></div>
            <button class="test-button" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5001/api/v1';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
        }

        async function makeLoginRequest(email, password) {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, password })
            });

            let responseData;
            try {
                responseData = await response.json();
            } catch (e) {
                responseData = { 
                    success: false, 
                    error: { 
                        code: 'PARSE_ERROR', 
                        message: `æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯ (HTTP ${response.status})` 
                    } 
                };
            }

            if (!response.ok) {
                let errorMessage = '';
                
                if (responseData.error && responseData.error.message) {
                    errorMessage = responseData.error.message;
                } else if (responseData.message) {
                    errorMessage = responseData.message;
                } else {
                    errorMessage = `è¯·æ±‚å¤±è´¥ (HTTP ${response.status})`;
                }
                
                const error = new Error(errorMessage);
                error.response = responseData;
                error.status = response.status;
                throw error;
            }

            return responseData;
        }

        async function testUserNotExists() {
            log('å¼€å§‹æµ‹è¯•ï¼šç”¨æˆ·ä¸å­˜åœ¨');
            try {
                const result = await makeLoginRequest('nonexistent@example.com', 'password123');
                showResult('userNotExistsResult', 'error', 'âŒ æµ‹è¯•å¤±è´¥ï¼šåº”è¯¥è¿”å›ç”¨æˆ·ä¸å­˜åœ¨é”™è¯¯');
                log('âŒ ç”¨æˆ·ä¸å­˜åœ¨æµ‹è¯•å¤±è´¥ï¼šæ²¡æœ‰æŠ›å‡ºé”™è¯¯');
            } catch (error) {
                const message = error.message;
                log(`âœ… æ•è·åˆ°é”™è¯¯ï¼š${message}`);
                
                if (message.includes('ç”¨æˆ·ä¸å­˜åœ¨')) {
                    showResult('userNotExistsResult', 'success', `âœ… æµ‹è¯•æˆåŠŸï¼<br>é”™è¯¯ä¿¡æ¯ï¼š${message}`);
                    log('âœ… ç”¨æˆ·ä¸å­˜åœ¨æµ‹è¯•é€šè¿‡');
                } else {
                    showResult('userNotExistsResult', 'error', `âš ï¸ é”™è¯¯ä¿¡æ¯ä¸åŒ¹é…<br>å®é™…ä¿¡æ¯ï¼š${message}`);
                    log(`âš ï¸ ç”¨æˆ·ä¸å­˜åœ¨æµ‹è¯•å¤±è´¥ï¼šé”™è¯¯ä¿¡æ¯ä¸åŒ¹é… - ${message}`);
                }
            }
        }

        async function testWrongPassword() {
            log('å¼€å§‹æµ‹è¯•ï¼šå¯†ç é”™è¯¯');
            try {
                // é¦–å…ˆç¡®ä¿æµ‹è¯•ç”¨æˆ·å­˜åœ¨
                const result = await makeLoginRequest('393893095@qq.com', 'wrongpassword');
                showResult('wrongPasswordResult', 'error', 'âŒ æµ‹è¯•å¤±è´¥ï¼šåº”è¯¥è¿”å›å¯†ç é”™è¯¯');
                log('âŒ å¯†ç é”™è¯¯æµ‹è¯•å¤±è´¥ï¼šæ²¡æœ‰æŠ›å‡ºé”™è¯¯');
            } catch (error) {
                const message = error.message;
                log(`âœ… æ•è·åˆ°é”™è¯¯ï¼š${message}`);
                
                if (message.includes('å¯†ç é”™è¯¯')) {
                    showResult('wrongPasswordResult', 'success', `âœ… æµ‹è¯•æˆåŠŸï¼<br>é”™è¯¯ä¿¡æ¯ï¼š${message}`);
                    log('âœ… å¯†ç é”™è¯¯æµ‹è¯•é€šè¿‡');
                } else if (message.includes('ç”¨æˆ·ä¸å­˜åœ¨')) {
                    showResult('wrongPasswordResult', 'info', `â„¹ï¸ æµ‹è¯•ç”¨æˆ·ä¸å­˜åœ¨<br>è¯·å…ˆåˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼š393893095@qq.com`);
                    log('â„¹ï¸ æµ‹è¯•ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º');
                } else {
                    showResult('wrongPasswordResult', 'error', `âš ï¸ é”™è¯¯ä¿¡æ¯ä¸åŒ¹é…<br>å®é™…ä¿¡æ¯ï¼š${message}`);
                    log(`âš ï¸ å¯†ç é”™è¯¯æµ‹è¯•å¤±è´¥ï¼šé”™è¯¯ä¿¡æ¯ä¸åŒ¹é… - ${message}`);
                }
            }
        }

        async function testNetworkError() {
            log('å¼€å§‹æµ‹è¯•ï¼šç½‘ç»œé”™è¯¯');
            try {
                // ä½¿ç”¨é”™è¯¯çš„URLæ¨¡æ‹Ÿç½‘ç»œé”™è¯¯
                const response = await fetch('http://localhost:9999/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'test@example.com', password: 'password' })
                });
                showResult('networkErrorResult', 'error', 'âŒ æµ‹è¯•å¤±è´¥ï¼šåº”è¯¥äº§ç”Ÿç½‘ç»œé”™è¯¯');
                log('âŒ ç½‘ç»œé”™è¯¯æµ‹è¯•å¤±è´¥ï¼šæ²¡æœ‰æŠ›å‡ºé”™è¯¯');
            } catch (error) {
                const message = error.message;
                log(`âœ… æ•è·åˆ°ç½‘ç»œé”™è¯¯ï¼š${message}`);
                showResult('networkErrorResult', 'success', `âœ… ç½‘ç»œé”™è¯¯æµ‹è¯•æˆåŠŸï¼<br>é”™è¯¯ä¿¡æ¯ï¼š${message}`);
            }
        }

        async function testSuccessfulLogin() {
            log('å¼€å§‹æµ‹è¯•ï¼šæ­£å¸¸ç™»å½•');
            try {
                const result = await makeLoginRequest('393893095@qq.com', '123456');
                if (result.success && result.data) {
                    showResult('successfulLoginResult', 'success', `âœ… ç™»å½•æˆåŠŸï¼<br>ç”¨æˆ·ï¼š${result.data.user.email}`);
                    log(`âœ… ç™»å½•æˆåŠŸï¼š${result.data.user.email}`);
                } else {
                    showResult('successfulLoginResult', 'error', 'âŒ ç™»å½•å“åº”æ ¼å¼é”™è¯¯');
                    log('âŒ ç™»å½•å“åº”æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                const message = error.message;
                log(`âŒ ç™»å½•å¤±è´¥ï¼š${message}`);
                
                if (message.includes('ç”¨æˆ·ä¸å­˜åœ¨')) {
                    showResult('successfulLoginResult', 'info', `â„¹ï¸ æµ‹è¯•ç”¨æˆ·ä¸å­˜åœ¨<br>è¯·å…ˆåˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼š393893095@qq.com / 123456`);
                } else {
                    showResult('successfulLoginResult', 'error', `âŒ ç™»å½•å¤±è´¥<br>é”™è¯¯ä¿¡æ¯ï¼š${message}`);
                }
            }
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå½“å‰æ—¶é—´å’Œæµ‹è¯•ç¯å¢ƒ
        window.onload = function() {
            log('=== ç™»å½•é”™è¯¯å¤„ç†æµ‹è¯•å¼€å§‹ ===');
            log(`æµ‹è¯•ç¯å¢ƒï¼š${API_BASE_URL}`);
            log(`æµ‹è¯•æ—¶é—´ï¼š${new Date().toLocaleString()}`);
        };
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³è¯†åˆ«è‡ªåŠ¨é‡å¯åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-panel {
            background-color: #f0f8ff;
            border: 1px solid #e0f2ff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background-color: #68C6F1;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px;
        }
        .status-listening {
            background-color: #d4edda;
            color: #155724;
        }
        .status-stopped {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status-auto-restart {
            background-color: #fff3cd;
            color: #856404;
        }
        .log {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .transcript-area {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            min-height: 100px;
            margin: 10px 0;
        }
        .test-scenario {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ è¯­éŸ³è¯†åˆ«è‡ªåŠ¨é‡å¯åŠŸèƒ½æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¿®æ”¹åçš„è¯­éŸ³è¯†åˆ«æ˜¯å¦åœ¨é¡µé¢å¤±å»ç„¦ç‚¹æˆ–é•¿æ—¶é—´æ— å£°éŸ³æ—¶ä¸ä¼šè‡ªåŠ¨ç»“æŸ</p>

        <div class="status-panel">
            <h3>å½“å‰çŠ¶æ€</h3>
            <div id="statusIndicators">
                <span class="status-indicator status-stopped">ğŸ›‘ æœªå¯åŠ¨</span>
                <span class="status-indicator" id="autoRestartStatus">ğŸ”„ è‡ªåŠ¨é‡å¯ï¼šæœªå¯ç”¨</span>
            </div>
            <div style="margin-top: 10px;">
                <strong>è¯­éŸ³è¯†åˆ«çŠ¶æ€ï¼š</strong> <span id="recognitionStatus">æœªå¯åŠ¨</span><br>
                <strong>æœ€åæ´»åŠ¨æ—¶é—´ï¼š</strong> <span id="lastActivity">-</span><br>
                <strong>é‡å¯æ¬¡æ•°ï¼š</strong> <span id="restartCount">0</span>
            </div>
        </div>

        <div class="status-panel">
            <h3>æ§åˆ¶é¢æ¿</h3>
            <button class="btn btn-primary" onclick="startRecognition()">ğŸ¤ å¯åŠ¨è¯­éŸ³è¯†åˆ«ï¼ˆå¸¦è‡ªåŠ¨é‡å¯ï¼‰</button>
            <button class="btn btn-danger" onclick="stopRecognition()">ğŸ›‘ åœæ­¢è¯­éŸ³è¯†åˆ«</button>
            <button class="btn btn-success" onclick="clearLog()">ğŸ§¹ æ¸…é™¤æ—¥å¿—</button>
        </div>

        <div class="test-scenario">
            <h3>ğŸ§ª æµ‹è¯•åœºæ™¯</h3>
            <p><strong>æµ‹è¯•1ï¼š</strong> å¯åŠ¨è¯­éŸ³è¯†åˆ«åï¼Œåˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µ15ç§’ï¼Œç„¶åå›æ¥æ£€æŸ¥æ˜¯å¦è¿˜åœ¨è¿è¡Œ</p>
            <p><strong>æµ‹è¯•2ï¼š</strong> å¯åŠ¨è¯­éŸ³è¯†åˆ«åï¼Œä¿æŒé™é»˜30ç§’ï¼Œæ£€æŸ¥æ˜¯å¦è‡ªåŠ¨é‡å¯</p>
            <p><strong>æµ‹è¯•3ï¼š</strong> è¯´è¯ä¸€æ®µæ—¶é—´ï¼Œç„¶åé™é»˜ï¼Œè§‚å¯Ÿè‡ªåŠ¨é‡å¯è¡Œä¸º</p>
            <button class="btn btn-primary" onclick="simulateTabSwitch()">æ¨¡æ‹Ÿæ ‡ç­¾é¡µåˆ‡æ¢æµ‹è¯•</button>
            <button class="btn btn-primary" onclick="testLongSilence()">æµ‹è¯•é•¿æ—¶é—´é™é»˜</button>
        </div>

        <div class="status-panel">
            <h3>å®æ—¶è½¬å½•</h3>
            <div class="transcript-area" id="transcriptArea">
                <em>è¯­éŸ³è½¬å½•å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</em>
            </div>
            <div>
                <strong>ä¸´æ—¶è½¬å½•ï¼š</strong> <span id="interimTranscript" style="color: #666; font-style: italic;"></span>
            </div>
        </div>

        <div id="logContainer" class="log">
            <strong>æ“ä½œæ—¥å¿—:</strong><br>
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        let recognition = null;
        let isListening = false;
        let shouldAutoRestart = false;
        let isManuallyStoppedRef = false;
        let restartCount = 0;
        let lastActivityTime = null;

        function log(message) {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `[${timestamp}] ${message}<br>`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        function updateStatus() {
            const statusIndicators = document.getElementById('statusIndicators');
            const recognitionStatus = document.getElementById('recognitionStatus');
            const autoRestartStatus = document.getElementById('autoRestartStatus');
            const lastActivity = document.getElementById('lastActivity');
            const restartCountEl = document.getElementById('restartCount');

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            if (isListening) {
                statusIndicators.innerHTML = '<span class="status-indicator status-listening">ğŸ¤ æ­£åœ¨ç›‘å¬</span>';
                recognitionStatus.textContent = 'æ­£åœ¨è¿è¡Œ';
            } else {
                statusIndicators.innerHTML = '<span class="status-indicator status-stopped">ğŸ›‘ å·²åœæ­¢</span>';
                recognitionStatus.textContent = 'æœªè¿è¡Œ';
            }

            // è‡ªåŠ¨é‡å¯çŠ¶æ€
            if (shouldAutoRestart) {
                autoRestartStatus.textContent = 'ğŸ”„ è‡ªåŠ¨é‡å¯ï¼šå·²å¯ç”¨';
                autoRestartStatus.className = 'status-indicator status-auto-restart';
            } else {
                autoRestartStatus.textContent = 'ğŸ”„ è‡ªåŠ¨é‡å¯ï¼šæœªå¯ç”¨';
                autoRestartStatus.className = 'status-indicator';
            }

            // æœ€åæ´»åŠ¨æ—¶é—´
            lastActivity.textContent = lastActivityTime ? lastActivityTime.toLocaleTimeString() : '-';
            
            // é‡å¯æ¬¡æ•°
            restartCountEl.textContent = restartCount;
        }

        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
                return false;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                log('ğŸ¤ è¯­éŸ³è¯†åˆ«å¼€å§‹');
                isListening = true;
                lastActivityTime = new Date();
                updateStatus();
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    const transcriptArea = document.getElementById('transcriptArea');
                    transcriptArea.innerHTML += `<div><strong>[${new Date().toLocaleTimeString()}]</strong> ${finalTranscript}</div>`;
                    transcriptArea.scrollTop = transcriptArea.scrollHeight;
                    log(`ğŸ“ è¯­éŸ³è½¬å½•: ${finalTranscript.substring(0, 50)}...`);
                    lastActivityTime = new Date();
                    updateStatus();
                }

                document.getElementById('interimTranscript').textContent = interimTranscript;
            };

            recognition.onerror = (event) => {
                log(`ğŸ” è¯­éŸ³è¯†åˆ«äº‹ä»¶: ${event.error}`);
                
                if (event.error === 'no-speech') {
                    log('âš ï¸ æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¿™æ˜¯æ­£å¸¸çš„');
                    return;
                } else if (event.error === 'audio-capture') {
                    log('âŒ éº¦å…‹é£è®¿é—®é”™è¯¯');
                    isListening = false;
                    updateStatus();
                } else if (event.error === 'not-allowed') {
                    log('âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»');
                    isListening = false;
                    updateStatus();
                } else if (event.error === 'network') {
                    log('âŒ ç½‘ç»œé”™è¯¯');
                    isListening = false;
                    updateStatus();
                } else {
                    log(`âŒ å…¶ä»–è¯­éŸ³è¯†åˆ«é”™è¯¯: ${event.error}`);
                    isListening = false;
                    updateStatus();
                }
            };

            recognition.onend = () => {
                log('ğŸ›‘ è¯­éŸ³è¯†åˆ«ç»“æŸ');
                isListening = false;
                document.getElementById('interimTranscript').textContent = '';
                updateStatus();
                
                // è‡ªåŠ¨é‡å¯é€»è¾‘
                if (shouldAutoRestart && !isManuallyStoppedRef) {
                    log('ğŸ”„ æ£€æµ‹åˆ°è¯­éŸ³è¯†åˆ«æ„å¤–ç»“æŸï¼Œå‡†å¤‡è‡ªåŠ¨é‡å¯...');
                    setTimeout(() => {
                        if (shouldAutoRestart && !isManuallyStoppedRef && recognition) {
                            try {
                                log('ğŸ”„ è‡ªåŠ¨é‡å¯è¯­éŸ³è¯†åˆ«');
                                recognition.start();
                                restartCount++;
                                updateStatus();
                            } catch (err) {
                                log(`âŒ è‡ªåŠ¨é‡å¯è¯­éŸ³è¯†åˆ«å¤±è´¥: ${err.message}`);
                                // é‡è¯•
                                setTimeout(() => {
                                    if (shouldAutoRestart && !isManuallyStoppedRef && recognition) {
                                        try {
                                            log('ğŸ”„ é‡è¯•è‡ªåŠ¨é‡å¯è¯­éŸ³è¯†åˆ«');
                                            recognition.start();
                                            restartCount++;
                                            updateStatus();
                                        } catch (retryErr) {
                                            log(`âŒ é‡è¯•è‡ªåŠ¨é‡å¯ä¹Ÿå¤±è´¥: ${retryErr.message}`);
                                        }
                                    }
                                }, 2000);
                            }
                        }
                    }, 1000);
                } else {
                    log('ğŸ›‘ è¯­éŸ³è¯†åˆ«æ­£å¸¸ç»“æŸï¼Œä¸è‡ªåŠ¨é‡å¯');
                }
            };

            return true;
        }

        function startRecognition() {
            if (!recognition && !initSpeechRecognition()) {
                return;
            }

            if (isListening) {
                log('âš ï¸ è¯­éŸ³è¯†åˆ«å·²åœ¨è¿è¡Œ');
                return;
            }

            try {
                log('ğŸ¤ å¯åŠ¨è¯­éŸ³è¯†åˆ«ï¼ˆå¯ç”¨è‡ªåŠ¨é‡å¯åŠŸèƒ½ï¼‰');
                isManuallyStoppedRef = false;
                shouldAutoRestart = true;
                recognition.start();
                updateStatus();
            } catch (err) {
                log(`âŒ å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥: ${err.message}`);
            }
        }

        function stopRecognition() {
            if (!isListening) {
                log('âš ï¸ è¯­éŸ³è¯†åˆ«æœªåœ¨è¿è¡Œ');
                return;
            }

            log('ğŸ›‘ ç”¨æˆ·æ‰‹åŠ¨åœæ­¢è¯­éŸ³è¯†åˆ«');
            isManuallyStoppedRef = true;
            shouldAutoRestart = false;
            
            try {
                recognition.stop();
                updateStatus();
            } catch (err) {
                log(`âŒ åœæ­¢è¯­éŸ³è¯†åˆ«å¤±è´¥: ${err.message}`);
            }
        }

        function clearLog() {
            document.getElementById('logContent').innerHTML = '';
            document.getElementById('transcriptArea').innerHTML = '<em>è¯­éŸ³è½¬å½•å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</em>';
            document.getElementById('interimTranscript').textContent = '';
            restartCount = 0;
            updateStatus();
            log('ğŸ§¹ æ—¥å¿—å’Œè½¬å½•å†…å®¹å·²æ¸…é™¤');
        }

        function simulateTabSwitch() {
            log('ğŸ§ª å¼€å§‹æ¨¡æ‹Ÿæ ‡ç­¾é¡µåˆ‡æ¢æµ‹è¯•...');
            log('ğŸ“± è¯·æ‰‹åŠ¨åˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µï¼Œç­‰å¾…15ç§’åå›æ¥æŸ¥çœ‹ç»“æœ');
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
            const handleVisibilityChange = () => {
                if (document.hidden) {
                    log('ğŸ“± é¡µé¢å¤±å»ç„¦ç‚¹ï¼Œè¯­éŸ³è¯†åˆ«åº”è¯¥ç»§ç»­è¿è¡Œ');
                } else {
                    log('ğŸ“± é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹ï¼Œæ£€æŸ¥è¯­éŸ³è¯†åˆ«çŠ¶æ€');
                    if (shouldAutoRestart && !isListening && !isManuallyStoppedRef && recognition) {
                        log('ğŸ”„ é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹ï¼Œå°è¯•é‡å¯è¯­éŸ³è¯†åˆ«');
                        setTimeout(() => {
                            try {
                                recognition.start();
                                restartCount++;
                                updateStatus();
                            } catch (err) {
                                log(`âŒ é¡µé¢ç„¦ç‚¹æ¢å¤åé‡å¯å¤±è´¥: ${err.message}`);
                            }
                        }, 500);
                    }
                }
            };

            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // 10ç§’åç§»é™¤ç›‘å¬å™¨
            setTimeout(() => {
                document.removeEventListener('visibilitychange', handleVisibilityChange);
                log('âœ… æ ‡ç­¾é¡µåˆ‡æ¢æµ‹è¯•ç›‘å¬ç»“æŸ');
            }, 30000);
        }

        function testLongSilence() {
            log('ğŸ§ª å¼€å§‹é•¿æ—¶é—´é™é»˜æµ‹è¯•...');
            log('ğŸ¤ è¯·ä¿æŒé™é»˜30ç§’ï¼Œè§‚å¯Ÿè¯­éŸ³è¯†åˆ«æ˜¯å¦è‡ªåŠ¨é‡å¯');
            
            let silenceStartTime = Date.now();
            const checkInterval = setInterval(() => {
                const elapsed = (Date.now() - silenceStartTime) / 1000;
                if (elapsed >= 30) {
                    clearInterval(checkInterval);
                    log('âœ… é•¿æ—¶é—´é™é»˜æµ‹è¯•å®Œæˆï¼ˆ30ç§’ï¼‰');
                } else {
                    log(`â±ï¸ é™é»˜æµ‹è¯•è¿›è¡Œä¸­... ${Math.floor(elapsed)}ç§’`);
                }
            }, 5000);
        }

        // åˆå§‹åŒ–
        updateStatus();
        log('ğŸ¯ è¯­éŸ³è¯†åˆ«è‡ªåŠ¨é‡å¯æµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('ğŸ“ ä¿®æ”¹å†…å®¹ï¼šé˜²æ­¢é¡µé¢å¤±å»ç„¦ç‚¹å’Œé•¿æ—¶é—´æ— å£°éŸ³æ—¶è‡ªåŠ¨ç»“æŸ');
        
        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
        if (initSpeechRecognition()) {
            log('âœ… è¯­éŸ³è¯†åˆ«åˆå§‹åŒ–æˆåŠŸ');
        }
    </script>
</body>
</html> 
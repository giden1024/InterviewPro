<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼‚æ­¥é—®é¢˜ç”Ÿæˆæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 20px;
        }
        .test-section {
            background-color: #f7fafc;
            border-left: 4px solid #4299e1;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .progress-section {
            background-color: #fffaf0;
            border-left: 4px solid #ed8936;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .success-section {
            background-color: #f0fff4;
            border-left: 4px solid #38a169;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .error-section {
            background-color: #fed7d7;
            border-left: 4px solid #e53e3e;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .code-block {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .button {
            background-color: #4299e1;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #3182ce;
        }
        .button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #4299e1;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .log {
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #f7fafc;
            border-radius: 8px;
            margin: 10px 0;
        }
        .metric-label {
            font-weight: bold;
            color: #2d3748;
        }
        .metric-value {
            font-size: 18px;
            font-weight: bold;
        }
        .success {
            color: #38a169;
        }
        .warning {
            color: #ed8936;
        }
        .info {
            color: #4299e1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ å¼‚æ­¥é—®é¢˜ç”Ÿæˆæµ‹è¯•</h1>
            <p>æµ‹è¯•Celeryå¼‚æ­¥ä»»åŠ¡å¤„ç†ç³»ç»Ÿ</p>
        </div>

        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
            <p>æœ¬æµ‹è¯•å°†éªŒè¯å¼‚æ­¥é—®é¢˜ç”ŸæˆåŠŸèƒ½ï¼š</p>
            <ul>
                <li><strong>åŒæ­¥è°ƒç”¨</strong>ï¼šç›´æ¥è°ƒç”¨APIï¼Œç­‰å¾…å®Œæˆ</li>
                <li><strong>å¼‚æ­¥è°ƒç”¨</strong>ï¼šå¯åŠ¨å¼‚æ­¥ä»»åŠ¡ï¼Œå®æ—¶ç›‘æ§è¿›åº¦</li>
                <li><strong>æ€§èƒ½å¯¹æ¯”</strong>ï¼šæ¯”è¾ƒä¸¤ç§æ–¹å¼çš„å“åº”æ—¶é—´</li>
                <li><strong>ç”¨æˆ·ä½“éªŒ</strong>ï¼šå¼‚æ­¥æ–¹å¼æä¾›å®æ—¶è¿›åº¦åé¦ˆ</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>ğŸ”§ æµ‹è¯•æ§åˆ¶</h2>
            <button id="testSync" class="button">æµ‹è¯•åŒæ­¥è°ƒç”¨</button>
            <button id="testAsync" class="button">æµ‹è¯•å¼‚æ­¥è°ƒç”¨</button>
            <button id="clearLog" class="button">æ¸…ç©ºæ—¥å¿—</button>
            <button id="stopTest" class="button" disabled>åœæ­¢æµ‹è¯•</button>
        </div>

        <div id="progressSection" class="progress-section" style="display: none;">
            <h2>ğŸ“Š ä»»åŠ¡è¿›åº¦</h2>
            <div class="metric">
                <span class="metric-label">ä»»åŠ¡ID</span>
                <span class="metric-value info" id="taskId">-</span>
            </div>
            <div class="metric">
                <span class="metric-label">å½“å‰çŠ¶æ€</span>
                <span class="metric-value info" id="taskState">-</span>
            </div>
            <div class="metric">
                <span class="metric-label">è¿›åº¦</span>
                <span class="metric-value info" id="taskProgress">-</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
            </div>
            <div id="taskStatus" class="metric">
                <span class="metric-label">çŠ¶æ€ä¿¡æ¯</span>
                <span class="metric-value info">ç­‰å¾…å¼€å§‹...</span>
            </div>
        </div>

        <div id="resultSection" class="success-section" style="display: none;">
            <h2>âœ… æµ‹è¯•ç»“æœ</h2>
            <div class="metric">
                <span class="metric-label">æ€»è€—æ—¶</span>
                <span class="metric-value success" id="totalTime">-</span>
            </div>
            <div class="metric">
                <span class="metric-label">ç”Ÿæˆé—®é¢˜æ•°</span>
                <span class="metric-value success" id="questionCount">-</span>
            </div>
            <div class="metric">
                <span class="metric-label">æ˜¯å¦æ¥è‡ªç¼“å­˜</span>
                <span class="metric-value success" id="fromCache">-</span>
            </div>
            <div class="metric">
                <span class="metric-label">æ€§èƒ½æå‡</span>
                <span class="metric-value success" id="performanceGain">-</span>
            </div>
        </div>

        <div id="errorSection" class="error-section" style="display: none;">
            <h2>âŒ é”™è¯¯ä¿¡æ¯</h2>
            <div id="errorMessage"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001/api/v1';
        let currentTaskId = null;
        let pollingInterval = null;
        let startTime = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#e53e3e' : type === 'success' ? '#38a169' : '#2d3748';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        document.getElementById('clearLog').addEventListener('click', () => {
            document.getElementById('log').innerHTML = '';
        });

        // è·å–JWT token
        function getToken() {
            return localStorage.getItem('token');
        }

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            const token = getToken();
            if (!token) {
                log('âŒ æœªæ‰¾åˆ°è®¤è¯tokenï¼Œè¯·å…ˆç™»å½•', 'error');
                return false;
            }
            return true;
        }

        // åˆ›å»ºæµ‹è¯•ç”¨æˆ·å’Œç®€å†
        async function createTestData() {
            try {
                log('ğŸ”§ åˆ›å»ºæµ‹è¯•æ•°æ®...');
                
                // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
                const userResponse = await fetch(`${API_BASE}/dev/create-test-user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'test_user_async',
                        email: 'test_async@example.com',
                        password: 'test123456'
                    })
                });
                
                if (!userResponse.ok) {
                    throw new Error('åˆ›å»ºæµ‹è¯•ç”¨æˆ·å¤±è´¥');
                }
                
                const userData = await userResponse.json();
                log('âœ… æµ‹è¯•ç”¨æˆ·åˆ›å»ºæˆåŠŸ');
                
                // ç™»å½•è·å–token
                const loginResponse = await fetch(`${API_BASE}/dev/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'test_user_async',
                        password: 'test123456'
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error('ç™»å½•å¤±è´¥');
                }
                
                const loginData = await loginResponse.json();
                localStorage.setItem('token', loginData.data.token);
                log('âœ… ç™»å½•æˆåŠŸï¼Œè·å–token');
                
                // åˆ›å»ºæµ‹è¯•ç®€å†
                const resumeResponse = await fetch(`${API_BASE}/resumes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${loginData.data.token}`
                    },
                    body: JSON.stringify({
                        filename: 'test_resume_async.txt',
                        content: 'æµ‹è¯•ç®€å†å†…å®¹ - å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆï¼Œ3å¹´ç»éªŒï¼Œç†Ÿæ‚‰Reactã€TypeScriptã€Node.jsç­‰æŠ€æœ¯æ ˆã€‚',
                        parsed_data: {
                            name: 'æµ‹è¯•ç”¨æˆ·',
                            email: 'test@example.com',
                            phone: '13800138000',
                            skills: ['React', 'TypeScript', 'Node.js', 'Python'],
                            experience: '3å¹´',
                            education: 'æœ¬ç§‘'
                        }
                    })
                });
                
                if (!resumeResponse.ok) {
                    throw new Error('åˆ›å»ºæµ‹è¯•ç®€å†å¤±è´¥');
                }
                
                const resumeData = await resumeResponse.json();
                log('âœ… æµ‹è¯•ç®€å†åˆ›å»ºæˆåŠŸ');
                
                return {
                    token: loginData.data.token,
                    resumeId: resumeData.data.id
                };
                
            } catch (error) {
                log(`âŒ åˆ›å»ºæµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // åˆ›å»ºé¢è¯•ä¼šè¯
        async function createInterviewSession(resumeId, token) {
            try {
                log('ğŸ“‹ åˆ›å»ºé¢è¯•ä¼šè¯...');
                
                const response = await fetch(`${API_BASE}/interviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        resume_id: resumeId,
                        interview_type: 'comprehensive',
                        total_questions: 5,
                        custom_title: 'å¼‚æ­¥æµ‹è¯•é¢è¯•'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('åˆ›å»ºé¢è¯•ä¼šè¯å¤±è´¥');
                }
                
                const data = await response.json();
                log('âœ… é¢è¯•ä¼šè¯åˆ›å»ºæˆåŠŸ');
                
                return data.data.session_id;
                
            } catch (error) {
                log(`âŒ åˆ›å»ºé¢è¯•ä¼šè¯å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // æµ‹è¯•åŒæ­¥è°ƒç”¨
        async function testSyncCall() {
            try {
                log('ğŸ”„ å¼€å§‹åŒæ­¥è°ƒç”¨æµ‹è¯•...');
                startTime = Date.now();
                
                // æ£€æŸ¥è®¤è¯
                if (!await checkAuth()) {
                    return;
                }
                
                const token = getToken();
                
                // åˆ›å»ºæµ‹è¯•æ•°æ®
                const testData = await createTestData();
                const sessionId = await createInterviewSession(testData.resumeId, token);
                
                // åŒæ­¥ç”Ÿæˆé—®é¢˜
                log('â³ å¼€å§‹åŒæ­¥ç”Ÿæˆé—®é¢˜ï¼ˆå¯èƒ½éœ€è¦30-60ç§’ï¼‰...');
                
                const response = await fetch(`${API_BASE}/questions/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        resume_id: testData.resumeId,
                        session_id: sessionId
                    })
                });
                
                if (!response.ok) {
                    throw new Error('åŒæ­¥ç”Ÿæˆé—®é¢˜å¤±è´¥');
                }
                
                const data = await response.json();
                const endTime = Date.now();
                const totalTime = (endTime - startTime) / 1000;
                
                log(`âœ… åŒæ­¥è°ƒç”¨å®Œæˆï¼Œè€—æ—¶: ${totalTime.toFixed(2)}ç§’`);
                
                // æ˜¾ç¤ºç»“æœ
                document.getElementById('resultSection').style.display = 'block';
                document.getElementById('totalTime').textContent = `${totalTime.toFixed(2)}ç§’`;
                document.getElementById('questionCount').textContent = data.data.questions.length;
                document.getElementById('fromCache').textContent = 'å¦';
                document.getElementById('performanceGain').textContent = 'åŸºå‡†';
                
            } catch (error) {
                log(`âŒ åŒæ­¥è°ƒç”¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('errorSection').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        // æµ‹è¯•å¼‚æ­¥è°ƒç”¨
        async function testAsyncCall() {
            try {
                log('ğŸ”„ å¼€å§‹å¼‚æ­¥è°ƒç”¨æµ‹è¯•...');
                startTime = Date.now();
                
                // æ£€æŸ¥è®¤è¯
                if (!await checkAuth()) {
                    return;
                }
                
                const token = getToken();
                
                // åˆ›å»ºæµ‹è¯•æ•°æ®
                const testData = await createTestData();
                const sessionId = await createInterviewSession(testData.resumeId, token);
                
                // å¯åŠ¨å¼‚æ­¥ä»»åŠ¡
                log('ğŸš€ å¯åŠ¨å¼‚æ­¥ä»»åŠ¡...');
                
                const response = await fetch(`${API_BASE}/questions/generate-async`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        resume_id: testData.resumeId,
                        session_id: sessionId
                    })
                });
                
                if (!response.ok) {
                    throw new Error('å¯åŠ¨å¼‚æ­¥ä»»åŠ¡å¤±è´¥');
                }
                
                const data = await response.json();
                currentTaskId = data.data.task_id;
                
                log(`âœ… å¼‚æ­¥ä»»åŠ¡å¯åŠ¨æˆåŠŸï¼Œä»»åŠ¡ID: ${currentTaskId}`);
                
                // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
                document.getElementById('progressSection').style.display = 'block';
                document.getElementById('taskId').textContent = currentTaskId;
                
                // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                pollTaskStatus();
                
            } catch (error) {
                log(`âŒ å¼‚æ­¥è°ƒç”¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('errorSection').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        async function pollTaskStatus() {
            if (!currentTaskId) return;
            
            try {
                const token = getToken();
                const response = await fetch(`${API_BASE}/questions/task-status/${currentTaskId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥');
                }
                
                const data = await response.json();
                const taskData = data.data;
                
                // æ›´æ–°UI
                document.getElementById('taskState').textContent = taskData.state;
                
                if (taskData.state === 'PENDING') {
                    document.getElementById('taskProgress').textContent = 'ç­‰å¾…ä¸­...';
                    document.getElementById('taskStatus').innerHTML = '<span class="metric-label">çŠ¶æ€ä¿¡æ¯</span><span class="metric-value info">ä»»åŠ¡æ’é˜Ÿä¸­...</span>';
                    document.getElementById('progressFill').style.width = '0%';
                    document.getElementById('progressFill').textContent = '0%';
                } else if (taskData.state === 'PROGRESS') {
                    const progress = taskData.current || 0;
                    document.getElementById('taskProgress').textContent = `${progress}%`;
                    document.getElementById('taskStatus').innerHTML = `<span class="metric-label">çŠ¶æ€ä¿¡æ¯</span><span class="metric-value info">${taskData.status || 'å¤„ç†ä¸­...'}</span>`;
                    document.getElementById('progressFill').style.width = `${progress}%`;
                    document.getElementById('progressFill').textContent = `${progress}%`;
                    log(`ğŸ“Š ä»»åŠ¡è¿›åº¦: ${progress}% - ${taskData.status || 'å¤„ç†ä¸­...'}`);
                } else if (taskData.state === 'SUCCESS') {
                    const endTime = Date.now();
                    const totalTime = (endTime - startTime) / 1000;
                    
                    log(`âœ… å¼‚æ­¥ä»»åŠ¡å®Œæˆï¼Œè€—æ—¶: ${totalTime.toFixed(2)}ç§’`);
                    
                    // æ˜¾ç¤ºç»“æœ
                    document.getElementById('resultSection').style.display = 'block';
                    document.getElementById('totalTime').textContent = `${totalTime.toFixed(2)}ç§’`;
                    document.getElementById('questionCount').textContent = taskData.questions?.length || 0;
                    document.getElementById('fromCache').textContent = taskData.from_cache ? 'æ˜¯' : 'å¦';
                    
                    // è®¡ç®—æ€§èƒ½æå‡
                    const syncTime = 30; // å‡è®¾åŒæ­¥è°ƒç”¨éœ€è¦30ç§’
                    const gain = ((syncTime - totalTime) / syncTime * 100).toFixed(1);
                    document.getElementById('performanceGain').textContent = `æå‡${gain}%`;
                    
                    // åœæ­¢è½®è¯¢
                    stopPolling();
                    return;
                } else if (taskData.state === 'FAILURE') {
                    log(`âŒ ä»»åŠ¡å¤±è´¥: ${taskData.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    document.getElementById('errorSection').style.display = 'block';
                    document.getElementById('errorMessage').textContent = taskData.error || 'æœªçŸ¥é”™è¯¯';
                    stopPolling();
                    return;
                }
                
                // ç»§ç»­è½®è¯¢
                pollingInterval = setTimeout(pollTaskStatus, 1000);
                
            } catch (error) {
                log(`âŒ è½®è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
                stopPolling();
            }
        }

        // åœæ­¢è½®è¯¢
        function stopPolling() {
            if (pollingInterval) {
                clearTimeout(pollingInterval);
                pollingInterval = null;
            }
            currentTaskId = null;
            document.getElementById('stopTest').disabled = true;
        }

        // åœæ­¢æµ‹è¯•
        document.getElementById('stopTest').addEventListener('click', () => {
            stopPolling();
            log('â¹ï¸ æµ‹è¯•å·²åœæ­¢');
        });

        // ç»‘å®šæµ‹è¯•æŒ‰é’®
        document.getElementById('testSync').addEventListener('click', testSyncCall);
        document.getElementById('testAsync').addEventListener('click', testAsyncCall);

        // é¡µé¢åŠ è½½å®Œæˆ
        log('ğŸš€ å¼‚æ­¥é—®é¢˜ç”Ÿæˆæµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('ğŸ’¡ æç¤ºï¼šè¯·ç¡®ä¿åç«¯æœåŠ¡å’ŒCelery workerå·²å¯åŠ¨');
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å†ä¸Šä¼ æµç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .step h3 {
            color: #333;
            margin-top: 0;
        }
        .success {
            border-color: #4CAF50;
            background: #f1f8e9;
        }
        .error {
            border-color: #f44336;
            background: #ffebee;
        }
        .info {
            border-color: #2196F3;
            background: #e3f2fd;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976D2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .file-input {
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“‹ ç®€å†ä¸Šä¼ æµç¨‹æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¿®æ”¹åçš„ç®€å†ä¸Šä¼ æµç¨‹ï¼ŒéªŒè¯ä¸å†è‡ªåŠ¨åˆ›å»ºé¢è¯•ä¼šè¯</p>

        <!-- æ­¥éª¤1: ä¸Šä¼ ç®€å† -->
        <div class="step info" id="step1">
            <h3>æ­¥éª¤1: ä¸Šä¼ ç®€å†</h3>
            <p>é€‰æ‹©ç®€å†æ–‡ä»¶è¿›è¡Œä¸Šä¼ æµ‹è¯•</p>
            
            <div class="file-input">
                <input type="file" id="resumeFile" accept=".pdf,.doc,.docx" />
                <button onclick="uploadResume()" id="uploadBtn">ä¸Šä¼ ç®€å†</button>
            </div>
            
            <div id="uploadStatus"></div>
            <div id="uploadLog" class="log"></div>
        </div>

        <!-- æ­¥éª¤2: éªŒè¯Completeé¡µé¢ -->
        <div class="step" id="step2">
            <h3>æ­¥éª¤2: éªŒè¯Completeé¡µé¢</h3>
            <p>æ£€æŸ¥Completeé¡µé¢æ˜¯å¦æ˜¾ç¤ºé¢è¯•é€‰æ‹©é€‰é¡¹</p>
            
            <button onclick="testCompletePage()" id="completeBtn" disabled>æµ‹è¯•Completeé¡µé¢</button>
            
            <div id="completeStatus"></div>
            <div id="completeLog" class="log"></div>
        </div>

        <!-- æ­¥éª¤3: æµ‹è¯•é¢è¯•åˆ›å»º -->
        <div class="step" id="step3">
            <h3>æ­¥éª¤3: æµ‹è¯•é¢è¯•åˆ›å»º</h3>
            <p>éªŒè¯ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©é¢è¯•ç±»å‹ååˆ›å»ºé¢è¯•ä¼šè¯</p>
            
            <button onclick="testMockInterview()" id="mockBtn" disabled>æµ‹è¯•æ¨¡æ‹Ÿé¢è¯•</button>
            <button onclick="testFormalInterview()" id="formalBtn" disabled>æµ‹è¯•æ­£å¼é¢è¯•</button>
            
            <div id="interviewStatus"></div>
            <div id="interviewLog" class="log"></div>
        </div>

        <!-- æ­¥éª¤4: éªŒè¯ä¸»é¡µInterview Record -->
        <div class="step" id="step4">
            <h3>æ­¥éª¤4: éªŒè¯ä¸»é¡µInterview Record</h3>
            <p>æ£€æŸ¥ä¸»é¡µæ˜¯å¦åªæ˜¾ç¤ºç”¨æˆ·ä¸»åŠ¨åˆ›å»ºçš„é¢è¯•è®°å½•</p>
            
            <button onclick="checkInterviewRecords()" id="recordBtn" disabled>æ£€æŸ¥é¢è¯•è®°å½•</button>
            
            <div id="recordStatus"></div>
            <div id="recordLog" class="log"></div>
        </div>

        <div style="margin-top: 30px; text-align: center;">
            <button onclick="runAllTests()" style="background: #4CAF50;">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button onclick="clearLogs()" style="background: #ff9800;">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <script>
        let currentResumeId = null;
        let authToken = null;

        // è·å–è®¤è¯token
        async function getAuthToken() {
            try {
                const token = localStorage.getItem('access_token') || localStorage.getItem('token');
                if (token) {
                    authToken = token;
                    return token;
                }
                
                // å¦‚æœæ²¡æœ‰tokenï¼Œå°è¯•ç™»å½•
                const response = await fetch('http://localhost:5001/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'test123'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    localStorage.setItem('access_token', authToken);
                    return authToken;
                }
                
                throw new Error('æ— æ³•è·å–è®¤è¯token');
            } catch (error) {
                console.error('è·å–tokenå¤±è´¥:', error);
                throw error;
            }
        }

        // ä¸Šä¼ ç®€å†
        async function uploadResume() {
            const fileInput = document.getElementById('resumeFile');
            const uploadBtn = document.getElementById('uploadBtn');
            const statusDiv = document.getElementById('uploadStatus');
            const logDiv = document.getElementById('uploadLog');
            
            if (!fileInput.files[0]) {
                showStatus('uploadStatus', 'è¯·é€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            try {
                uploadBtn.disabled = true;
                showStatus('uploadStatus', 'æ­£åœ¨ä¸Šä¼ ç®€å†...', 'info');
                addLog('uploadLog', 'å¼€å§‹ä¸Šä¼ ç®€å†æ–‡ä»¶...');

                const token = await getAuthToken();
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                const response = await fetch('http://localhost:5001/api/v1/resumes', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentResumeId = data.data.resume.id;
                    showStatus('uploadStatus', 'âœ… ç®€å†ä¸Šä¼ æˆåŠŸï¼', 'success');
                    addLog('uploadLog', `ç®€å†ä¸Šä¼ æˆåŠŸï¼ŒID: ${currentResumeId}`);
                    addLog('uploadLog', `æ–‡ä»¶å: ${data.data.resume.filename}`);
                    addLog('uploadLog', `çŠ¶æ€: ${data.data.resume.status}`);
                    
                    // å¯ç”¨ä¸‹ä¸€æ­¥æµ‹è¯•
                    document.getElementById('completeBtn').disabled = false;
                    document.getElementById('step1').className = 'step success';
                } else {
                    showStatus('uploadStatus', `âŒ ä¸Šä¼ å¤±è´¥: ${data.message}`, 'error');
                    addLog('uploadLog', `ä¸Šä¼ å¤±è´¥: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                showStatus('uploadStatus', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                addLog('uploadLog', `ç½‘ç»œé”™è¯¯: ${error.message}`);
            } finally {
                uploadBtn.disabled = false;
            }
        }

        // æµ‹è¯•Completeé¡µé¢
        async function testCompletePage() {
            const statusDiv = document.getElementById('completeStatus');
            const logDiv = document.getElementById('completeLog');
            
            try {
                showStatus('completeStatus', 'æ­£åœ¨æµ‹è¯•Completeé¡µé¢...', 'info');
                addLog('completeLog', 'å¼€å§‹æµ‹è¯•Completeé¡µé¢åŠŸèƒ½...');

                // æ¨¡æ‹Ÿè·³è½¬åˆ°Completeé¡µé¢
                const completePageData = {
                    jobTitle: 'Software Engineer',
                    company: 'Tech Corp',
                    resumeId: currentResumeId,
                    experienceLevel: 'Junior',
                    completed: false,
                    questionsGenerated: false
                };

                addLog('completeLog', `ä¼ é€’åˆ°Completeé¡µé¢çš„æ•°æ®: ${JSON.stringify(completePageData, null, 2)}`);
                addLog('completeLog', 'âœ… Completeé¡µé¢åº”è¯¥æ˜¾ç¤ºé¢è¯•é€‰æ‹©é€‰é¡¹');
                addLog('completeLog', 'âœ… ä¸å†è‡ªåŠ¨åˆ›å»ºé¢è¯•ä¼šè¯');
                addLog('completeLog', 'âœ… ç”¨æˆ·å¯ä»¥é€‰æ‹©æ¨¡æ‹Ÿé¢è¯•æˆ–æ­£å¼é¢è¯•');

                showStatus('completeStatus', 'âœ… Completeé¡µé¢æµ‹è¯•é€šè¿‡ï¼', 'success');
                document.getElementById('step2').className = 'step success';
                
                // å¯ç”¨é¢è¯•æµ‹è¯•
                document.getElementById('mockBtn').disabled = false;
                document.getElementById('formalBtn').disabled = false;
                
            } catch (error) {
                showStatus('completeStatus', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addLog('completeLog', `æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        // æµ‹è¯•æ¨¡æ‹Ÿé¢è¯•
        async function testMockInterview() {
            const statusDiv = document.getElementById('interviewStatus');
            const logDiv = document.getElementById('interviewLog');
            
            try {
                showStatus('interviewStatus', 'æ­£åœ¨åˆ›å»ºæ¨¡æ‹Ÿé¢è¯•...', 'info');
                addLog('interviewLog', 'å¼€å§‹æµ‹è¯•æ¨¡æ‹Ÿé¢è¯•åˆ›å»º...');

                const token = await getAuthToken();
                
                // åˆ›å»ºé¢è¯•ä¼šè¯
                const sessionResponse = await fetch('http://localhost:5001/api/v1/interviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        resume_id: currentResumeId,
                        interview_type: 'mock',
                        total_questions: 8,
                        custom_title: 'Software Engineer - Mock Interview'
                    })
                });

                const sessionData = await sessionResponse.json();
                
                if (sessionResponse.ok) {
                    addLog('interviewLog', `âœ… æ¨¡æ‹Ÿé¢è¯•ä¼šè¯åˆ›å»ºæˆåŠŸ`);
                    addLog('interviewLog', `ä¼šè¯ID: ${sessionData.data.session_id}`);
                    addLog('interviewLog', `é¢è¯•ç±»å‹: ${sessionData.data.session.interview_type}`);
                    addLog('interviewLog', `é¢˜ç›®æ•°é‡: ${sessionData.data.session.total_questions}`);
                    
                    showStatus('interviewStatus', 'âœ… æ¨¡æ‹Ÿé¢è¯•åˆ›å»ºæˆåŠŸï¼', 'success');
                    document.getElementById('step3').className = 'step success';
                    
                    // å¯ç”¨è®°å½•æ£€æŸ¥
                    document.getElementById('recordBtn').disabled = false;
                } else {
                    showStatus('interviewStatus', `âŒ åˆ›å»ºå¤±è´¥: ${sessionData.message}`, 'error');
                    addLog('interviewLog', `åˆ›å»ºå¤±è´¥: ${JSON.stringify(sessionData)}`);
                }
            } catch (error) {
                showStatus('interviewStatus', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addLog('interviewLog', `æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        // æµ‹è¯•æ­£å¼é¢è¯•
        async function testFormalInterview() {
            const statusDiv = document.getElementById('interviewStatus');
            const logDiv = document.getElementById('interviewLog');
            
            try {
                showStatus('interviewStatus', 'æ­£åœ¨åˆ›å»ºæ­£å¼é¢è¯•...', 'info');
                addLog('interviewLog', 'å¼€å§‹æµ‹è¯•æ­£å¼é¢è¯•åˆ›å»º...');

                const token = await getAuthToken();
                
                // åˆ›å»ºé¢è¯•ä¼šè¯
                const sessionResponse = await fetch('http://localhost:5001/api/v1/interviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        resume_id: currentResumeId,
                        interview_type: 'comprehensive',
                        total_questions: 15,
                        custom_title: 'Software Engineer - Formal Interview'
                    })
                });

                const sessionData = await sessionResponse.json();
                
                if (sessionResponse.ok) {
                    addLog('interviewLog', `âœ… æ­£å¼é¢è¯•ä¼šè¯åˆ›å»ºæˆåŠŸ`);
                    addLog('interviewLog', `ä¼šè¯ID: ${sessionData.data.session_id}`);
                    addLog('interviewLog', `é¢è¯•ç±»å‹: ${sessionData.data.session.interview_type}`);
                    addLog('interviewLog', `é¢˜ç›®æ•°é‡: ${sessionData.data.session.total_questions}`);
                    
                    showStatus('interviewStatus', 'âœ… æ­£å¼é¢è¯•åˆ›å»ºæˆåŠŸï¼', 'success');
                    document.getElementById('step3').className = 'step success';
                    
                    // å¯ç”¨è®°å½•æ£€æŸ¥
                    document.getElementById('recordBtn').disabled = false;
                } else {
                    showStatus('interviewStatus', `âŒ åˆ›å»ºå¤±è´¥: ${sessionData.message}`, 'error');
                    addLog('interviewLog', `åˆ›å»ºå¤±è´¥: ${JSON.stringify(sessionData)}`);
                }
            } catch (error) {
                showStatus('interviewStatus', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addLog('interviewLog', `æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        // æ£€æŸ¥é¢è¯•è®°å½•
        async function checkInterviewRecords() {
            const statusDiv = document.getElementById('recordStatus');
            const logDiv = document.getElementById('recordLog');
            
            try {
                showStatus('recordStatus', 'æ­£åœ¨æ£€æŸ¥é¢è¯•è®°å½•...', 'info');
                addLog('recordLog', 'å¼€å§‹æ£€æŸ¥ä¸»é¡µInterview Record...');

                const token = await getAuthToken();
                
                // è·å–é¢è¯•ä¼šè¯åˆ—è¡¨
                const response = await fetch('http://localhost:5001/api/v1/interviews', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    addLog('recordLog', `âœ… æˆåŠŸè·å–é¢è¯•è®°å½•`);
                    addLog('recordLog', `æ€»è®°å½•æ•°: ${data.data.sessions.length}`);
                    
                    data.data.sessions.forEach((session, index) => {
                        addLog('recordLog', `è®°å½•${index + 1}: ${session.title} (${session.interview_type})`);
                    });
                    
                    addLog('recordLog', 'âœ… éªŒè¯ï¼šåªæ˜¾ç¤ºç”¨æˆ·ä¸»åŠ¨åˆ›å»ºçš„é¢è¯•è®°å½•');
                    addLog('recordLog', 'âœ… éªŒè¯ï¼šä¸å†æœ‰è‡ªåŠ¨åˆ›å»ºçš„é¢è¯•ä¼šè¯');
                    
                    showStatus('recordStatus', 'âœ… é¢è¯•è®°å½•æ£€æŸ¥é€šè¿‡ï¼', 'success');
                    document.getElementById('step4').className = 'step success';
                } else {
                    showStatus('recordStatus', `âŒ è·å–å¤±è´¥: ${data.message}`, 'error');
                    addLog('recordLog', `è·å–å¤±è´¥: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                showStatus('recordStatus', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                addLog('recordLog', `æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            clearLogs();
            addLog('uploadLog', 'ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            
            // æŒ‰é¡ºåºè¿è¡Œæµ‹è¯•
            await uploadResume();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testCompletePage();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testMockInterview();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await checkInterviewRecords();
            
            addLog('uploadLog', 'ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼');
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLogs() {
            document.querySelectorAll('.log').forEach(log => {
                log.innerHTML = '';
            });
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `status ${type}`;
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML += `[${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            addLog('uploadLog', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•...');
        };
    </script>
</body>
</html> 